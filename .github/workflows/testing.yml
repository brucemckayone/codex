name: PR and Push CI (Neon ephemeral DB)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - "**" # Run on all branches

permissions:
  contents: read
  actions: write

env:
  EXPIRES_IN_DAYS: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  # Clean up ALL non-production Neon branches before creating new ones
  # This prevents hitting the 9-branch limit on Neon free tier
  cleanup-stale-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Install neonctl
        run: npm i -g neonctl@2

      - name: Delete all CI branches (keep only production)
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          echo "::add-mask::$NEON_API_KEY"
          echo "Listing all branches..."
          BRANCHES=$(neonctl branches list --project-id ${{ vars.NEON_PROJECT_ID }} --output json 2>/dev/null || echo "[]")

          # Count branches before cleanup
          BRANCH_COUNT=$(echo "$BRANCHES" | jq 'length')
          echo "Found $BRANCH_COUNT branches total"

          # Get the default/main branch name to protect it
          DEFAULT_BRANCH=$(echo "$BRANCHES" | jq -r '.[] | select(.default == true) | .name' | head -1)
          echo "Default branch: $DEFAULT_BRANCH"

          # Delete ALL branches except the default production branch
          # This includes: ci-test-branch, ci-e2e-branch, pr-*, push-*, and neon-testing ephemeral branches
          echo "$BRANCHES" | jq -r ".[] | select(.default != true) | .id" | while read branch_id; do
            if [ -n "$branch_id" ] && [ "$branch_id" != "null" ]; then
              BRANCH_NAME=$(echo "$BRANCHES" | jq -r ".[] | select(.id == \"$branch_id\") | .name")
              echo "Deleting branch: $BRANCH_NAME ($branch_id)"
              neonctl branches delete "$branch_id" --project-id ${{ vars.NEON_PROJECT_ID }} --force || true
            fi
          done

          echo "Cleanup complete"

  # Wait for static analysis to pass before running expensive tests
  static-analysis:
    needs: [cleanup-stale-branches]
    uses: ./.github/workflows/static_analysis.yml

  changes:
    runs-on: ubuntu-latest
    needs: [cleanup-stale-branches]  # Removed static-analysis - runs in parallel now
    outputs:
      database: ${{ steps.filter.outputs.database }}
      validation: ${{ steps.filter.outputs.validation }}
      cloudflare-clients: ${{ steps.filter.outputs.cloudflare-clients }}
      test-utils: ${{ steps.filter.outputs.test-utils }}
      security: ${{ steps.filter.outputs.security }}
      observability: ${{ steps.filter.outputs.observability }}
      worker-utils: ${{ steps.filter.outputs.worker-utils }}
      content: ${{ steps.filter.outputs.content }}
      identity: ${{ steps.filter.outputs.identity }}
      access: ${{ steps.filter.outputs.access }}
      purchase: ${{ steps.filter.outputs.purchase }}
      service-errors: ${{ steps.filter.outputs.service-errors }}
      shared-types: ${{ steps.filter.outputs.shared-types }}
      web: ${{ steps.filter.outputs.web }}
      auth-worker: ${{ steps.filter.outputs.auth-worker }}
      ecom-api: ${{ steps.filter.outputs.ecom-api }}
      content-api: ${{ steps.filter.outputs.content-api }}
      identity-api: ${{ steps.filter.outputs.identity-api }}
      organization-api: ${{ steps.filter.outputs.organization-api }}
      notifications-api: ${{ steps.filter.outputs.notifications-api }}
      admin-api: ${{ steps.filter.outputs.admin-api }}
    steps:
      - uses: actions/checkout@v4
      - name: Filter changed packages
        id: filter
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.pull_request.base.ref || github.event.repository.default_branch || 'main' }}
          filters: |
            database:
              - 'packages/database/**'
            validation:
              - 'packages/validation/**'
            cloudflare-clients:
              - 'packages/cloudflare-clients/**'
            test-utils:
              - 'packages/test-utils/**'
            security:
              - 'packages/security/**'
            observability:
              - 'packages/observability/**'
            worker-utils:
              - 'packages/worker-utils/**'
            content:
              - 'packages/content/**'
            identity:
              - 'packages/identity/**'
            access:
              - 'packages/access/**'
            purchase:
              - 'packages/purchase/**'
            service-errors:
              - 'packages/service-errors/**'
            shared-types:
              - 'packages/shared-types/**'
            web:
              - 'apps/web/**'
            auth-worker:
              - 'workers/auth/**'
            ecom-api:
              - 'workers/ecom-api/**'
            content-api:
              - 'workers/content-api/**'
            identity-api:
              - 'workers/identity-api/**'
            organization-api:
              - 'workers/organization-api/**'
            notifications-api:
              - 'workers/notifications-api/**'
            admin-api:
              - 'workers/admin-api/**'

  test:
    needs: [changes, static-analysis]  # Both must pass before running tests
    runs-on: ubuntu-latest
    # Use test environment for environment-specific secrets and variables
    environment: test
    strategy:
      matrix:
        node: [20]
    outputs:
      branch_id: ${{ steps.create-branch.outputs.branch_id }}
    steps:
      - uses: actions/checkout@v4

      # Use a single reusable branch name for CI unit tests
      # The cleanup job deletes this at the start of each run
      - name: Generate Neon Branch Name
        id: branch-name
        run: |
          # Unique branch per run to avoid race conditions with concurrent workflows
          echo "name=ci-unit-tests-${{ github.run_id }}" >> $GITHUB_OUTPUT

      # Create Neon branch for unit tests
      - name: Create Neon branch for tests
        id: create-branch
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: ${{ steps.branch-name.outputs.name }}
          parent: production
          username: neondb_owner
          api_key: ${{ secrets.NEON_API_KEY }}

      # Install dependencies
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Turborepo local cache - optimized for test job
      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-test-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-test-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-
            ${{ runner.os }}-turbo-test-
            ${{ runner.os }}-turbo-

      # Build @codex/constants before migrations (required dependency)
      - name: Build constants package
        run: pnpm --filter @codex/constants build

      # Database Setup: Apply committed migrations to ephemeral branch
      # Note: Migrations are generated locally and committed; CI only applies them
      # Note: db_url_with_pooler from create-branch step is available in this job
      - name: Apply migrations to ephemeral branch
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm --filter @codex/database db:migrate

      # Save DATABASE_URL for preview deployments
      - name: Save Neon connection details to artifact
        run: |
          echo "${{ steps.create-branch.outputs.db_url_with_pooler }}" > database-url.txt
          echo "${{ steps.create-branch.outputs.branch_id }}" > branch-id.txt
          echo "${{ steps.branch-name.outputs.name }}" > branch-name.txt

      - name: Upload Neon connection artifact
        uses: actions/upload-artifact@v4
        with:
          name: neon-connection-${{ github.run_id }}
          path: |
            database-url.txt
            branch-id.txt
            branch-name.txt
          retention-days: 7 # Keep for workflow_run delays

      # Build all packages and workers in parallel using Turborepo
      # Turborepo automatically handles dependencies and parallelization
      - name: Build all with Turborepo (parallel)
        run: pnpm build
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      # Generate .dev.vars.test files for worker tests
      # vitest-pool-workers uses wrangler which reads these files for env vars
      - name: Generate worker dev vars for unit tests
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: ${{ vars.DB_METHOD }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET_BOOKING: ${{ secrets.STRIPE_WEBHOOK_SECRET_BOOKING }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
        run: |
          echo "::add-mask::$DATABASE_URL"
          echo "::add-mask::$R2_SECRET_ACCESS_KEY"
          echo "::add-mask::$STRIPE_SECRET_KEY"
          echo "::add-mask::$STRIPE_WEBHOOK_SECRET_BOOKING"
          echo "::add-mask::$BETTER_AUTH_SECRET"
          chmod +x .github/scripts/generate-dev-vars.sh
          .github/scripts/generate-dev-vars.sh

      # Run unit/package tests using Turborepo with smart filtering
      # Turborepo will automatically detect changed packages and their dependents
      - name: Run tests for affected packages with Turborepo
        id: run-tests
        env:
          # Database connection from workflow-level Neon branch
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: ${{ vars.DB_METHOD }}
          # R2 credentials for tests (using test buckets from environment)
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          # Turborepo configuration
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info
        run: |
          echo "::add-mask::$DATABASE_URL"
          # Use Turborepo's built-in change detection instead of manual filtering
          # This runs tests for changed packages and packages that depend on them
          pnpm test
        continue-on-error: true # Allow artifact upload even if tests fail

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_id }}
          path: |
            packages/*/coverage/
            workers/*/coverage/
          retention-days: 7
          if-no-files-found: ignore

      - name: Fail if tests failed
        if: steps.run-tests.outcome == 'failure'
        run: exit 1

      # Cleanup: Delete Neon branch immediately after job completes
      - name: Cleanup Neon branch
        if: always() && steps.create-branch.outputs.branch_id
        run: |
          npm i -g neonctl@2
          neonctl branches delete ${{ steps.create-branch.outputs.branch_id }} --project-id ${{ vars.NEON_PROJECT_ID }} --force || true
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}

  # ============================================================================
  # WORKER TESTS - Matrix Strategy (7 workers in parallel)
  # Each worker gets its own Neon branch for test isolation
  # Consolidated from 7 separate jobs into 1 matrix job (~650 lines saved)
  # ============================================================================

  worker-tests:
    name: ${{ matrix.name }} Tests
    needs: [changes, test]
    runs-on: ubuntu-latest
    # Run if unit tests passed - individual worker conditions checked in steps
    if: always() && needs.test.result == 'success'
    environment: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Auth Worker
            worker: auth
            dir: workers/auth
            branch_name: ci-auth-tests
            turbo_key: auth-test
            # Secrets: BETTER_AUTH_SECRET only
            needs_r2: false
            needs_stripe: false

          - name: Content API
            worker: content-api
            dir: workers/content-api
            branch_name: ci-content-api-tests
            turbo_key: content-api-test
            # Secrets: R2, STRIPE, BETTER_AUTH_SECRET
            needs_r2: true
            needs_stripe: true

          - name: Identity API
            worker: identity-api
            dir: workers/identity-api
            branch_name: ci-identity-api-tests
            turbo_key: identity-api-test
            # Secrets: BETTER_AUTH_SECRET only
            needs_r2: false
            needs_stripe: false

          - name: Admin API
            worker: admin-api
            dir: workers/admin-api
            branch_name: ci-admin-api-tests
            turbo_key: admin-api-test
            # Secrets: BETTER_AUTH_SECRET only
            needs_r2: false
            needs_stripe: false

          - name: Ecom API
            worker: ecom-api
            dir: workers/ecom-api
            branch_name: ci-ecom-api-tests
            turbo_key: ecom-api-test
            # Secrets: STRIPE, BETTER_AUTH_SECRET
            needs_r2: false
            needs_stripe: true

          - name: Organization API
            worker: organization-api
            dir: workers/organization-api
            branch_name: ci-organization-api-tests
            turbo_key: organization-api-test
            # Secrets: BETTER_AUTH_SECRET only
            needs_r2: false
            needs_stripe: false

          - name: Notifications API
            worker: notifications-api
            dir: workers/notifications-api
            branch_name: ci-notifications-api-tests
            turbo_key: notifications-api-test
            # Secrets: BETTER_AUTH_SECRET only
            needs_r2: false
            needs_stripe: false

    # Note: Each matrix job cleans up its own Neon branch inline (no outputs needed)

    steps:
      # Step 1: Check if this worker should run based on changed files
      - name: Check if worker should run
        id: should-run
        run: |
          # Common dependencies that trigger ALL worker tests
          COMMON_CHANGED="${{ needs.changes.outputs.worker-utils == 'true' || needs.changes.outputs.database == 'true' || needs.changes.outputs.security == 'true' }}"

          # Worker-specific conditions
          case "${{ matrix.worker }}" in
            auth)
              WORKER_CHANGED="${{ needs.changes.outputs.auth-worker == 'true' }}"
              ;;
            content-api)
              WORKER_CHANGED="${{ needs.changes.outputs.content-api == 'true' || needs.changes.outputs.content == 'true' || needs.changes.outputs.access == 'true' || needs.changes.outputs.cloudflare-clients == 'true' }}"
              ;;
            identity-api)
              WORKER_CHANGED="${{ needs.changes.outputs.identity-api == 'true' || needs.changes.outputs.identity == 'true' }}"
              ;;
            admin-api)
              WORKER_CHANGED="${{ needs.changes.outputs.admin-api == 'true' || needs.changes.outputs.observability == 'true' || needs.changes.outputs.service-errors == 'true' || needs.changes.outputs.shared-types == 'true' || needs.changes.outputs.validation == 'true' }}"
              ;;
            ecom-api)
              WORKER_CHANGED="${{ needs.changes.outputs.ecom-api == 'true' || needs.changes.outputs.purchase == 'true' || needs.changes.outputs.validation == 'true' }}"
              ;;
            organization-api)
              WORKER_CHANGED="${{ needs.changes.outputs.organization-api == 'true' || needs.changes.outputs.identity == 'true' }}"
              ;;
            notifications-api)
              WORKER_CHANGED="${{ needs.changes.outputs.notifications-api == 'true' }}"
              ;;
            *)
              WORKER_CHANGED="false"
              ;;
          esac

          if [ "$COMMON_CHANGED" = "true" ] || [ "$WORKER_CHANGED" = "true" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "✓ Running ${{ matrix.name }} tests (changes detected)"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "⊘ Skipping ${{ matrix.name }} tests (no relevant changes)"
          fi

      - uses: actions/checkout@v4
        if: steps.should-run.outputs.should_run == 'true'

      - name: Create Neon branch
        id: create-branch
        if: steps.should-run.outputs.should_run == 'true'
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: ${{ matrix.branch_name }}
          parent: production
          username: neondb_owner
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Install pnpm
        if: steps.should-run.outputs.should_run == 'true'
        uses: pnpm/action-setup@v4

      - name: Use Node.js
        if: steps.should-run.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        if: steps.should-run.outputs.should_run == 'true'
        run: pnpm install --frozen-lockfile

      - name: Cache Turborepo
        if: steps.should-run.outputs.should_run == 'true'
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ matrix.turbo_key }}-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-${{ matrix.turbo_key }}-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-
            ${{ runner.os }}-turbo-${{ matrix.turbo_key }}-
            ${{ runner.os }}-turbo-

      - name: Build constants package
        if: steps.should-run.outputs.should_run == 'true'
        run: pnpm --filter @codex/constants build

      - name: Apply migrations
        if: steps.should-run.outputs.should_run == 'true'
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm --filter @codex/database db:migrate

      - name: Build dependencies
        if: steps.should-run.outputs.should_run == 'true'
        run: pnpm build
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      - name: Generate worker dev vars
        if: steps.should-run.outputs.should_run == 'true'
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: ${{ vars.DB_METHOD }}
          # Always needed
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          # Conditionally used based on matrix.needs_r2
          R2_ACCOUNT_ID: ${{ matrix.needs_r2 && secrets.R2_ACCOUNT_ID || '' }}
          R2_ACCESS_KEY_ID: ${{ matrix.needs_r2 && secrets.R2_ACCESS_KEY_ID || '' }}
          R2_SECRET_ACCESS_KEY: ${{ matrix.needs_r2 && secrets.R2_SECRET_ACCESS_KEY || '' }}
          R2_BUCKET_MEDIA: ${{ matrix.needs_r2 && vars.R2_BUCKET_MEDIA || '' }}
          # Conditionally used based on matrix.needs_stripe
          STRIPE_SECRET_KEY: ${{ matrix.needs_stripe && secrets.STRIPE_SECRET_KEY || '' }}
          STRIPE_WEBHOOK_SECRET_BOOKING: ${{ matrix.needs_stripe && secrets.STRIPE_WEBHOOK_SECRET_BOOKING || '' }}
        run: |
          echo "::add-mask::$DATABASE_URL"
          echo "::add-mask::$BETTER_AUTH_SECRET"
          [ -n "$R2_SECRET_ACCESS_KEY" ] && echo "::add-mask::$R2_SECRET_ACCESS_KEY"
          [ -n "$STRIPE_SECRET_KEY" ] && echo "::add-mask::$STRIPE_SECRET_KEY"
          [ -n "$STRIPE_WEBHOOK_SECRET_BOOKING" ] && echo "::add-mask::$STRIPE_WEBHOOK_SECRET_BOOKING"
          chmod +x .github/scripts/generate-worker-dev-vars.sh
          .github/scripts/generate-worker-dev-vars.sh ${{ matrix.worker }}

      - name: Run ${{ matrix.worker }} tests
        id: run-tests
        if: steps.should-run.outputs.should_run == 'true'
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: ${{ vars.DB_METHOD }}
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          # R2 env vars for content-api tests
          R2_ACCOUNT_ID: ${{ matrix.needs_r2 && secrets.R2_ACCOUNT_ID || '' }}
          R2_ACCESS_KEY_ID: ${{ matrix.needs_r2 && secrets.R2_ACCESS_KEY_ID || '' }}
          R2_SECRET_ACCESS_KEY: ${{ matrix.needs_r2 && secrets.R2_SECRET_ACCESS_KEY || '' }}
          R2_BUCKET_MEDIA: ${{ matrix.needs_r2 && vars.R2_BUCKET_MEDIA || '' }}
        run: |
          echo "::add-mask::$DATABASE_URL"
          cd ${{ matrix.dir }} && pnpm test
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always() && steps.should-run.outputs.should_run == 'true'
        with:
          name: ${{ matrix.worker }}-test-results-${{ github.run_id }}
          path: ${{ matrix.dir }}/coverage/**
          retention-days: 7

      - name: Fail if tests failed
        if: steps.should-run.outputs.should_run == 'true' && steps.run-tests.outcome == 'failure'
        run: exit 1

      # Cleanup: Delete Neon branch immediately after job completes
      - name: Cleanup Neon branch
        if: always() && steps.create-branch.outputs.branch_id
        run: |
          npm i -g neonctl@2
          neonctl branches delete ${{ steps.create-branch.outputs.branch_id }} --project-id ${{ vars.NEON_PROJECT_ID }} --force || true
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}

  # ============================================================================
  # E2E API TESTS - Root /e2e/ directory tests
  # Runs AFTER all worker tests complete
  # ============================================================================

  e2e-api-tests:
    name: E2E API Tests
    needs: [worker-tests]
    # Run if all worker tests passed or were skipped (no failures)
    if: always() && needs.worker-tests.result != 'failure'
    runs-on: ubuntu-latest
    environment: test
    outputs:
      branch_id: ${{ steps.create-branch.outputs.branch_id }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate Neon Branch Name
        id: branch-name
        run: echo "name=ci-e2e-api-tests" >> $GITHUB_OUTPUT

      - name: Create Neon branch for E2E API tests
        id: create-branch
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: ${{ steps.branch-name.outputs.name }}
          parent: production
          username: neondb_owner
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-e2e-api-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-e2e-api-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-
            ${{ runner.os }}-turbo-e2e-api-
            ${{ runner.os }}-turbo-

      - name: Build constants package
        run: pnpm --filter @codex/constants build

      - name: Apply migrations
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm --filter @codex/database db:migrate

      - name: Build dependencies
        run: pnpm build
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      - name: Generate worker dev vars for all workers
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: ${{ vars.DB_METHOD }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET_BOOKING: ${{ secrets.STRIPE_WEBHOOK_SECRET_BOOKING }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
        run: |
          echo "::add-mask::$DATABASE_URL"
          echo "::add-mask::$R2_SECRET_ACCESS_KEY"
          echo "::add-mask::$STRIPE_SECRET_KEY"
          echo "::add-mask::$STRIPE_WEBHOOK_SECRET_BOOKING"
          echo "::add-mask::$BETTER_AUTH_SECRET"
          chmod +x .github/scripts/generate-dev-vars.sh
          .github/scripts/generate-dev-vars.sh

      - name: Run E2E API tests
        id: run-tests
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: ${{ vars.DB_METHOD }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET_BOOKING: ${{ secrets.STRIPE_WEBHOOK_SECRET_BOOKING }}
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
        run: |
          echo "::add-mask::$DATABASE_URL"
          echo "::add-mask::$STRIPE_SECRET_KEY"
          pnpm test:e2e:api
        continue-on-error: true

      - name: Upload E2E API test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-api-test-results-${{ github.run_id }}
          path: |
            e2e/test-results.json
            e2e/test-results/**
          retention-days: 7

      - name: Fail if E2E API tests failed
        if: steps.run-tests.outcome == 'failure'
        run: exit 1

      # Cleanup: Delete Neon branch immediately after job completes
      - name: Cleanup Neon branch
        if: always() && steps.create-branch.outputs.branch_id
        run: |
          npm i -g neonctl@2
          neonctl branches delete ${{ steps.create-branch.outputs.branch_id }} --project-id ${{ vars.NEON_PROJECT_ID }} --force || true
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}

  # ============================================================================
  # E2E WEB TESTS - Web application E2E tests
  # ============================================================================

  e2e-tests:
    name: E2E Web Tests
    needs: [e2e-api-tests, changes]
    # Only run E2E web tests if:
    # 1. E2E API tests didn't fail
    # 2. AND there are web-related changes (web app, auth, or shared-types)
    if: |
      always() &&
      needs.e2e-api-tests.result != 'failure' &&
      (needs.changes.outputs.web == 'true' ||
       needs.changes.outputs.auth-worker == 'true' ||
       needs.changes.outputs.shared-types == 'true')
    runs-on: ubuntu-latest
    environment: test
    outputs:
      branch_id: ${{ steps.create-branch.outputs.branch_id }}
    steps:
      - uses: actions/checkout@v4

      # Use a single reusable branch name for E2E web tests
      - name: Generate Neon Branch Name
        id: branch-name
        run: echo "name=ci-e2e-web-tests" >> $GITHUB_OUTPUT

      # Create Neon branch for E2E tests
      - name: Create Neon branch for E2E
        id: create-branch
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: ${{ steps.branch-name.outputs.name }}
          parent: production
          username: neondb_owner
          api_key: ${{ secrets.NEON_API_KEY }}

      # Install dependencies
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Turborepo local cache - optimized for E2E job
      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-e2e-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-e2e-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-
            ${{ runner.os }}-turbo-e2e-
            ${{ runner.os }}-turbo-

      # Build @codex/constants before migrations (required dependency)
      - name: Build constants package
        run: pnpm --filter @codex/constants build

      # Database Setup: Apply committed migrations to ephemeral branch
      - name: Apply migrations to ephemeral branch
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm --filter @codex/database db:migrate

      # Build SvelteKit for Cloudflare Workers using Turborepo
      - name: Build SvelteKit app with Turborepo
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm build:web
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      # Generate .dev.vars.test files for workers to use in CI
      - name: Generate worker dev vars for E2E
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: ${{ vars.DB_METHOD }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET_BOOKING: ${{ secrets.STRIPE_WEBHOOK_SECRET_BOOKING }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
        run: |
          echo "::add-mask::$DATABASE_URL"
          echo "::add-mask::$STRIPE_SECRET_KEY"
          echo "::add-mask::$STRIPE_WEBHOOK_SECRET_BOOKING"
          echo "::add-mask::$R2_SECRET_ACCESS_KEY"
          echo "::add-mask::$BETTER_AUTH_SECRET"
          chmod +x .github/scripts/generate-dev-vars.sh
          .github/scripts/generate-dev-vars.sh

      # Run E2E tests against built worker using wrangler dev
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Start Wrangler dev server in background
        run: |
          echo "::add-mask::$DATABASE_URL"
          cd apps/web
          pnpm wrangler dev --port 8787 --local &
          echo $! > wrangler.pid
          # Wait for server to be ready
          timeout 60 bash -c 'until curl -f http://localhost:8787 > /dev/null 2>&1; do sleep 1; done'
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}

      - name: Run E2E tests
        env:
          CI: "true"
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: ${{ vars.DB_METHOD }}
          NODE_ENV: ${{ vars.NODE_ENV }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET_BOOKING: ${{ secrets.STRIPE_WEBHOOK_SECRET_BOOKING }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          PLAYWRIGHT_BASE_URL: http://localhost:8787
        run: |
          echo "::add-mask::$DATABASE_URL"
          echo "::add-mask::$STRIPE_SECRET_KEY"
          pnpm test:e2e

      - name: Stop Wrangler dev server
        if: always()
        run: |
          if [ -f apps/web/wrangler.pid ]; then
            kill $(cat apps/web/wrangler.pid) || true
            rm apps/web/wrangler.pid
          fi

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 30

      # Cleanup: Delete Neon branch immediately after job completes
      - name: Cleanup Neon branch
        if: always() && steps.create-branch.outputs.branch_id
        run: |
          npm i -g neonctl@2
          neonctl branches delete ${{ steps.create-branch.outputs.branch_id }} --project-id ${{ vars.NEON_PROJECT_ID }} --force || true
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}

  # ============================================================================
  # CLEANUP - Safety net for any missed Neon branch deletions
  # Note: Each test job already cleans up its own branch immediately after completion.
  # This job serves as a final safety net only for the unit test and E2E jobs
  # (worker-tests matrix jobs all clean up their own branches inline).
  # ============================================================================

  cleanup-neon-branches:
    name: Cleanup Neon Branches
    runs-on: ubuntu-latest
    needs: [test, worker-tests, e2e-api-tests, e2e-tests]
    if: always()
    steps:
      - name: Delete unit test branch (safety net)
        if: needs.test.result != 'skipped' && needs.test.outputs.branch_id && needs.test.outputs.branch_id != ''
        continue-on-error: true
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: ${{ needs.test.outputs.branch_id }}
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Delete E2E API test branch (safety net)
        if: needs.e2e-api-tests.result != 'skipped' && needs.e2e-api-tests.outputs.branch_id && needs.e2e-api-tests.outputs.branch_id != ''
        continue-on-error: true
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: ${{ needs.e2e-api-tests.outputs.branch_id }}
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Delete E2E web test branch (safety net)
        if: needs.e2e-tests.result != 'skipped' && needs.e2e-tests.outputs.branch_id && needs.e2e-tests.outputs.branch_id != ''
        continue-on-error: true
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: ${{ needs.e2e-tests.outputs.branch_id }}
          api_key: ${{ secrets.NEON_API_KEY }}
