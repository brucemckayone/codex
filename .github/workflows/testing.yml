name: PR and Push CI (Neon ephemeral DB)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - '**'  # Run on all branches for debugging

permissions:
  contents: read
  actions: write

env:
  EXPIRES_IN_DAYS: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      database: ${{ steps.filter.outputs.database }}
      validation: ${{ steps.filter.outputs.validation }}
      cloudflare-clients: ${{ steps.filter.outputs.cloudflare-clients }}
      test-utils: ${{ steps.filter.outputs.test-utils }}
      web: ${{ steps.filter.outputs.web }}
      auth-worker: ${{ steps.filter.outputs.auth-worker }}
      stripe-webhook-handler: ${{ steps.filter.outputs.stripe-webhook-handler }}
    steps:
      - uses: actions/checkout@v4
      - name: Filter changed packages
        id: filter
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.pull_request.base.ref || github.event.repository.default_branch || 'main' }}
          filters: |
            database:
              - 'packages/database/**'
            validation:
              - 'packages/validation/**'
            cloudflare-clients:
              - 'packages/cloudflare-clients/**'
            test-utils:
              - 'packages/test-utils/**'
            web:
              - 'apps/web/**'
            auth-worker:
              - 'workers/auth/**'
            stripe-webhook-handler:
              - 'workers/stripe-webhook-handler/**'

  test:
    needs: [changes]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [20]
    outputs:
      branch_id: ${{ steps.create-branch.outputs.branch_id }}
    steps:
      - uses: actions/checkout@v4

      # Generate Neon branch name
      - name: Generate Neon Branch Name
        id: branch-name
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "name=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
          else
            SANITIZED_REF_NAME=$(echo "${{ github.ref_name }}" | tr / -)
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
            BRANCH_NAME="push-${SANITIZED_REF_NAME}-${SHORT_SHA}"
            # truncate to 63 chars (Neon limit)
            BRANCH_NAME_TRUNC=${BRANCH_NAME:0:63}
            echo "name=${BRANCH_NAME_TRUNC}" >> $GITHUB_OUTPUT
          fi

      # Create Neon branch
      - name: Create Neon branch
        id: create-branch
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: ${{ steps.branch-name.outputs.name }}
          parent: main
          username: neondb_owner
          api_key: ${{ secrets.NEON_API_KEY }}

      # Install dependencies
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Run static analysis
      - name: Type check
        run: pnpm typecheck

      - name: Lint
        run: pnpm lint

      - name: Format check
        run: pnpm format:check

      # Database Setup: Generate and apply migrations to ephemeral branch
      # Note: db_url_with_pooler from create-branch step is available in this job
      - name: Generate migrations from schema
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: pnpm --filter @codex/database db:gen:drizzle

      - name: Apply migrations to ephemeral branch
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: pnpm --filter @codex/database db:migrate

      # Run tests for affected packages
      - name: Run tests for affected packages
        if: ${{ needs.changes.outputs.database == 'true' || needs.changes.outputs.validation == 'true' || needs.changes.outputs.cloudflare-clients == 'true' || needs.changes.outputs.test-utils == 'true' || needs.changes.outputs.web == 'true' || needs.changes.outputs.auth-worker == 'true' || needs.changes.outputs.stripe-webhook-handler == 'true' }}
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: |
          if [[ "${{ needs.changes.outputs.database }}" == "true" ]]; then pnpm --filter @codex/database test; fi
          if [[ "${{ needs.changes.outputs.validation }}" == "true" ]]; then pnpm --filter @codex/validation test; fi
          if [[ "${{ needs.changes.outputs.cloudflare-clients }}" == "true" ]]; then pnpm --filter @codex/cloudflare-clients test; fi
          if [[ "${{ needs.changes.outputs.test-utils }}" == "true" ]]; then pnpm --filter @codex/test-utils test; fi
          if [[ "${{ needs.changes.outputs.web }}" == "true" ]]; then pnpm --filter web test; fi
          if [[ "${{ needs.changes.outputs.auth-worker }}" == "true" ]]; then pnpm --filter auth test; fi
          if [[ "${{ needs.changes.outputs.stripe-webhook-handler }}" == "true" ]]; then pnpm --filter stripe-webhook-handler test; fi

  e2e-tests:
    name: E2E Tests
    needs: [changes]
    runs-on: ubuntu-latest
    if: ${{ needs.changes.outputs.web == 'true' }}
    outputs:
      branch_id: ${{ steps.create-branch.outputs.branch_id }}
    env:
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_TEST_KEY }}
    steps:
      - uses: actions/checkout@v4

      # Generate Neon branch name
      - name: Generate Neon Branch Name
        id: branch-name
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "name=pr-${{ github.event.number }}-e2e" >> $GITHUB_OUTPUT
          else
            SANITIZED_REF_NAME=$(echo "${{ github.ref_name }}" | tr / -)
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
            BRANCH_NAME="push-${SANITIZED_REF_NAME}-${SHORT_SHA}-e2e"
            # truncate to 63 chars (Neon limit)
            BRANCH_NAME_TRUNC=${BRANCH_NAME:0:63}
            echo "name=${BRANCH_NAME_TRUNC}" >> $GITHUB_OUTPUT
          fi

      # Create separate Neon branch for E2E tests
      - name: Create Neon branch for E2E
        id: create-branch
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: ${{ steps.branch-name.outputs.name }}
          parent: main
          username: neondb_owner
          api_key: ${{ secrets.NEON_API_KEY }}

      # Install dependencies
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Database Setup: Generate and apply migrations before E2E tests
      - name: Generate migrations
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: pnpm --filter @codex/database db:gen:drizzle

      - name: Apply migrations to ephemeral branch
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: pnpm --filter @codex/database db:migrate

      # Run E2E tests
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Run E2E tests
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: pnpm test:e2e

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 30

  cleanup-neon-branches:
    name: Cleanup Neon Branches
    runs-on: ubuntu-latest
    needs: [test, e2e-tests]
    if: always()
    steps:
      - name: Delete test branch
        if: needs.test.outputs.branch_id
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: ${{ needs.test.outputs.branch_id }}
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Delete E2E branch
        if: needs.e2e-tests.outputs.branch_id
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: ${{ needs.e2e-tests.outputs.branch_id }}
          api_key: ${{ secrets.NEON_API_KEY }}

  deploy-workers:
    name: Deploy Cloudflare Workers
    runs-on: ubuntu-latest
    needs: [test, e2e-tests]
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Deploy stripe-webhook-handler worker
        run: pnpm --filter stripe-webhook-handler deploy stripe-webhook-handler --legacy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      - name: Deployment notification
        if: success()
        run: echo "✅ Workers deployed successfully to production"
      - name: Deployment failed
        if: failure()
        run: echo "❌ Worker deployment failed - check logs"
