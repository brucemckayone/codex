name: PR and Push CI (Neon ephemeral DB)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - '**' # Run on all branches for debugging

permissions:
  contents: read
  actions: write

env:
  EXPIRES_IN_DAYS: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Wait for static analysis to pass before running expensive tests
  static-analysis:
    uses: ./.github/workflows/static_analysis.yml

  changes:
    runs-on: ubuntu-latest
    needs: [static-analysis]
    outputs:
      database: ${{ steps.filter.outputs.database }}
      validation: ${{ steps.filter.outputs.validation }}
      cloudflare-clients: ${{ steps.filter.outputs.cloudflare-clients }}
      test-utils: ${{ steps.filter.outputs.test-utils }}
      security: ${{ steps.filter.outputs.security }}
      observability: ${{ steps.filter.outputs.observability }}
      worker-utils: ${{ steps.filter.outputs.worker-utils }}
      content: ${{ steps.filter.outputs.content }}
      identity: ${{ steps.filter.outputs.identity }}
      service-errors: ${{ steps.filter.outputs.service-errors }}
      shared-types: ${{ steps.filter.outputs.shared-types }}
      web: ${{ steps.filter.outputs.web }}
      auth-worker: ${{ steps.filter.outputs.auth-worker }}
      stripe-webhook-handler: ${{ steps.filter.outputs.stripe-webhook-handler }}
      content-api: ${{ steps.filter.outputs.content-api }}
      identity-api: ${{ steps.filter.outputs.identity-api }}
    steps:
      - uses: actions/checkout@v4
      - name: Filter changed packages
        id: filter
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.pull_request.base.ref || github.event.repository.default_branch || 'main' }}
          filters: |
            database:
              - 'packages/database/**'
            validation:
              - 'packages/validation/**'
            cloudflare-clients:
              - 'packages/cloudflare-clients/**'
            test-utils:
              - 'packages/test-utils/**'
            security:
              - 'packages/security/**'
            observability:
              - 'packages/observability/**'
            worker-utils:
              - 'packages/worker-utils/**'
            content:
              - 'packages/content/**'
            identity:
              - 'packages/identity/**'
            service-errors:
              - 'packages/service-errors/**'
            shared-types:
              - 'packages/shared-types/**'
            web:
              - 'apps/web/**'
            auth-worker:
              - 'workers/auth/**'
            stripe-webhook-handler:
              - 'workers/stripe-webhook-handler/**'
            content-api:
              - 'workers/content-api/**'
            identity-api:
              - 'workers/identity-api/**'

  test:
    needs: [changes]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [20]
    outputs:
      branch_id: ${{ steps.create-branch.outputs.branch_id }}
    steps:
      - uses: actions/checkout@v4

      # Generate Neon branch name
      - name: Generate Neon Branch Name
        id: branch-name
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Include run_id for uniqueness across retries and re-runs
            PR_NUM=${{ github.event.number }}
            RUN_ID=${{ github.run_id }}
            # Truncate to fit Neon's 63 char limit
            BRANCH_NAME="pr-${PR_NUM}-${RUN_ID}"
            echo "name=${BRANCH_NAME:0:63}" >> $GITHUB_OUTPUT
          else
            SANITIZED_REF_NAME=$(echo "${{ github.ref_name }}" | tr / -)
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
            RUN_ID=${{ github.run_id }}
            BRANCH_NAME="push-${SANITIZED_REF_NAME}-${SHORT_SHA}-${RUN_ID}"
            # truncate to 63 chars (Neon limit)
            BRANCH_NAME_TRUNC=${BRANCH_NAME:0:63}
            echo "name=${BRANCH_NAME_TRUNC}" >> $GITHUB_OUTPUT
          fi

      # Create Neon branch
      - name: Create Neon branch
        id: create-branch
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: ${{ steps.branch-name.outputs.name }}
          parent: production
          username: neondb_owner
          api_key: ${{ secrets.NEON_API_KEY }}

      # Install dependencies
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Turborepo local cache - optimized for test job
      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-test-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-test-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-
            ${{ runner.os }}-turbo-test-
            ${{ runner.os }}-turbo-

      # Database Setup: Generate and apply migrations to ephemeral branch
      # Note: Static analysis (typecheck, lint, format) runs in separate workflow
      # Note: db_url_with_pooler from create-branch step is available in this job
      - name: Generate migrations from schema
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm --filter @codex/database db:gen:drizzle

      - name: Apply migrations to ephemeral branch
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm --filter @codex/database db:migrate

      # Save DATABASE_URL for preview deployments
      - name: Save Neon connection details to artifact
        run: |
          echo "${{ steps.create-branch.outputs.db_url_with_pooler }}" > database-url.txt
          echo "${{ steps.create-branch.outputs.branch_id }}" > branch-id.txt
          echo "${{ steps.branch-name.outputs.name }}" > branch-name.txt

      - name: Upload Neon connection artifact
        uses: actions/upload-artifact@v4
        with:
          name: neon-connection-${{ github.run_id }}
          path: |
            database-url.txt
            branch-id.txt
            branch-name.txt
          retention-days: 7 # Keep for workflow_run delays

      # Build all packages and workers in parallel using Turborepo
      # Turborepo automatically handles dependencies and parallelization
      - name: Build all with Turborepo (parallel)
        run: pnpm build
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      # Run tests using Turborepo with smart filtering
      # Turborepo will automatically detect changed packages and their dependents
      - name: Run tests for affected packages with Turborepo
        id: run-tests
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info
        run: |
          echo "::add-mask::$DATABASE_URL"
          # Use Turborepo's built-in change detection instead of manual filtering
          # This runs tests for changed packages and packages that depend on them
          pnpm test
        continue-on-error: true  # Allow artifact upload even if tests fail

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_id }}
          path: |
            **/coverage/**
            **/.vitest/**
            **/test-results/**
          retention-days: 7

      - name: Fail if tests failed
        if: steps.run-tests.outcome == 'failure'
        run: exit 1

  e2e-tests:
    name: E2E Tests
    needs: [changes]
    runs-on: ubuntu-latest
    if: ${{ needs.changes.outputs.web == 'true' }}
    outputs:
      branch_id: ${{ steps.create-branch.outputs.branch_id }}
    env:
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_TEST_KEY }}
    steps:
      - uses: actions/checkout@v4

      # Generate Neon branch name
      - name: Generate Neon Branch Name
        id: branch-name
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Include run_id for uniqueness across retries and re-runs
            PR_NUM=${{ github.event.number }}
            RUN_ID=${{ github.run_id }}
            BRANCH_NAME="pr-${PR_NUM}-${RUN_ID}-e2e"
            echo "name=${BRANCH_NAME:0:63}" >> $GITHUB_OUTPUT
          else
            SANITIZED_REF_NAME=$(echo "${{ github.ref_name }}" | tr / -)
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
            RUN_ID=${{ github.run_id }}
            BRANCH_NAME="push-${SANITIZED_REF_NAME}-${SHORT_SHA}-${RUN_ID}-e2e"
            # truncate to 63 chars (Neon limit)
            BRANCH_NAME_TRUNC=${BRANCH_NAME:0:63}
            echo "name=${BRANCH_NAME_TRUNC}" >> $GITHUB_OUTPUT
          fi

      # Create separate Neon branch for E2E tests
      - name: Create Neon branch for E2E
        id: create-branch
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: ${{ steps.branch-name.outputs.name }}
          parent: production
          username: neondb_owner
          api_key: ${{ secrets.NEON_API_KEY }}

      # Install dependencies
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Turborepo local cache - optimized for E2E job
      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-e2e-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-e2e-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-
            ${{ runner.os }}-turbo-e2e-
            ${{ runner.os }}-turbo-

      # Database Setup: Generate and apply migrations before E2E tests
      - name: Generate migrations
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm --filter @codex/database db:gen:drizzle

      - name: Apply migrations to ephemeral branch
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm --filter @codex/database db:migrate

      # Build SvelteKit for Cloudflare Workers using Turborepo
      - name: Build SvelteKit app with Turborepo
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm build:web
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      # Run E2E tests against built worker using wrangler dev
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Start Wrangler dev server in background
        run: |
          echo "::add-mask::$DATABASE_URL"
          cd apps/web
          pnpm wrangler dev --port 8787 --local &
          echo $! > wrangler.pid
          # Wait for server to be ready
          timeout 60 bash -c 'until curl -f http://localhost:8787 > /dev/null 2>&1; do sleep 1; done'
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}

      - name: Run E2E tests
        env:
          DATABASE_URL: ${{ steps.create-branch.outputs.db_url_with_pooler }}
          DB_METHOD: NEON_BRANCH
          PLAYWRIGHT_BASE_URL: http://localhost:8787
        run: |
          echo "::add-mask::$DATABASE_URL"
          pnpm test:e2e

      - name: Stop Wrangler dev server
        if: always()
        run: |
          if [ -f apps/web/wrangler.pid ]; then
            kill $(cat apps/web/wrangler.pid) || true
            rm apps/web/wrangler.pid
          fi

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 30

  cleanup-neon-branches:
    name: Cleanup Neon Branches
    runs-on: ubuntu-latest
    needs: [test, e2e-tests]
    if: always()
    steps:
      - name: Delete test branch
        if: needs.test.result != 'skipped' && needs.test.outputs.branch_id && needs.test.outputs.branch_id != ''
        continue-on-error: true
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: ${{ needs.test.outputs.branch_id }}
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Delete E2E branch
        if: needs.e2e-tests.result != 'skipped' && needs.e2e-tests.outputs.branch_id && needs.e2e-tests.outputs.branch_id != ''
        continue-on-error: true
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: ${{ needs.e2e-tests.outputs.branch_id }}
          api_key: ${{ secrets.NEON_API_KEY }}
