name: Sync R2 Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - '.github/config/r2-infrastructure.json'
      - '.github/scripts/manage-r2-infrastructure.sh'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - verify
          - apply
        default: 'verify'

permissions:
  contents: read

jobs:
  sync-r2:
    name: Sync R2 Infrastructure
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify R2 infrastructure configuration
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_R2_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        id: verify
        run: |
          echo "ðŸ” Verifying R2 infrastructure against config..."
          chmod +x .github/scripts/manage-r2-infrastructure.sh

          if .github/scripts/manage-r2-infrastructure.sh verify \
            ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} \
            ${{ secrets.CLOUDFLARE_ZONE_ID }} \
            ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}; then
            echo "verify_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… R2 infrastructure is already configured correctly"
          else
            echo "verify_passed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  R2 infrastructure needs updates"
          fi

      - name: Apply R2 infrastructure changes
        if: |
          (github.event_name == 'push' && steps.verify.outputs.verify_passed == 'false') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_R2_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ“ Applying R2 infrastructure changes..."
          .github/scripts/manage-r2-infrastructure.sh apply \
            ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} \
            ${{ secrets.CLOUDFLARE_ZONE_ID }} \
            ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

          echo "âœ… R2 infrastructure synchronized successfully"

      - name: Verify after apply
        if: |
          (github.event_name == 'push' && steps.verify.outputs.verify_passed == 'false') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_R2_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ” Re-verifying R2 infrastructure..."
          if .github/scripts/manage-r2-infrastructure.sh verify \
            ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} \
            ${{ secrets.CLOUDFLARE_ZONE_ID }} \
            ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}; then
            echo "âœ… Verification passed after apply"
          else
            echo "âŒ Verification failed after apply - manual intervention required"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“¦ R2 Infrastructure Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.verify.outputs.verify_passed }}" = "true" ]; then
            echo "âœ… **Infrastructure already configured correctly**" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ **Infrastructure changes applied**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Domain Structure (1:1 bucket-to-domain mapping)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Bucket Type | Custom Domain Pattern | Public | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|----------------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| codex-assets-* | cdn-assets[-env].revelations.studio | âœ… | Thumbnails, logos, branding |" >> $GITHUB_STEP_SUMMARY
          echo "| codex-media-* | cdn-media[-env].revelations.studio | âŒ | HLS streams (presigned URLs) |" >> $GITHUB_STEP_SUMMARY
          echo "| codex-platform-* | cdn-platform[-env].revelations.studio | âœ… | Email assets, legal docs |" >> $GITHUB_STEP_SUMMARY
          echo "| codex-resources-* | cdn-resources[-env].revelations.studio | âŒ | PDFs (presigned URLs) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Subdomains" >> $GITHUB_STEP_SUMMARY
          echo "- **Production**: \`cdn-{type}.revelations.studio\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview**: \`cdn-{type}-preview.revelations.studio\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Development**: \`cdn-{type}-dev.revelations.studio\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: No custom domains (uses R2 dev URLs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Media & Resources buckets are **private** - presigned URLs required" >> $GITHUB_STEP_SUMMARY
          echo "- Assets & Platform buckets are **public** for fast loading" >> $GITHUB_STEP_SUMMARY
          echo "- Production buckets disable R2 dev URLs for security" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Wrangler Bindings" >> $GITHUB_STEP_SUMMARY
          echo "- \`R2_ASSETS_URL_BASE\` - Public asset URLs" >> $GITHUB_STEP_SUMMARY
          echo "- \`R2_MEDIA_URL_BASE\` - Streaming media URLs" >> $GITHUB_STEP_SUMMARY
          echo "- \`R2_PLATFORM_URL_BASE\` - Platform content URLs" >> $GITHUB_STEP_SUMMARY
          echo "- \`R2_RESOURCES_URL_BASE\` - Downloadable resource URLs" >> $GITHUB_STEP_SUMMARY
