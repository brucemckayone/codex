name: Sync R2 Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - '.github/config/r2-infrastructure.json'
      - '.github/scripts/manage-r2-infrastructure.sh'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - verify
          - apply
        default: 'verify'

permissions:
  contents: read

jobs:
  sync-r2:
    name: Sync R2 Infrastructure
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Verify R2 infrastructure configuration
        id: verify
        run: |
          echo "ðŸ” Verifying R2 infrastructure against config..."
          chmod +x .github/scripts/manage-r2-infrastructure.sh

          if .github/scripts/manage-r2-infrastructure.sh verify \
            ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} \
            ${{ secrets.CLOUDFLARE_ZONE_ID }} \
            ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}; then
            echo "verify_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… R2 infrastructure is already configured correctly"
          else
            echo "verify_passed=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  R2 infrastructure needs updates"
          fi

      - name: Apply R2 infrastructure changes
        if: |
          (github.event_name == 'push' && steps.verify.outputs.verify_passed == 'false') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        run: |
          echo "ðŸ“ Applying R2 infrastructure changes..."
          .github/scripts/manage-r2-infrastructure.sh apply \
            ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} \
            ${{ secrets.CLOUDFLARE_ZONE_ID }} \
            ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

          echo "âœ… R2 infrastructure synchronized successfully"

      - name: Verify after apply
        if: |
          (github.event_name == 'push' && steps.verify.outputs.verify_passed == 'false') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        run: |
          echo "ðŸ” Re-verifying R2 infrastructure..."
          if .github/scripts/manage-r2-infrastructure.sh verify \
            ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} \
            ${{ secrets.CLOUDFLARE_ZONE_ID }} \
            ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}; then
            echo "âœ… Verification passed after apply"
          else
            echo "âŒ Verification failed after apply - manual intervention required"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“¦ R2 Infrastructure Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.verify.outputs.verify_passed }}" = "true" ]; then
            echo "âœ… **Infrastructure already configured correctly**" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ **Infrastructure changes applied**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configured Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Bucket | Custom Domain | Public Access | Notes |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------------|---------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| codex-media-* | cdn*.revelations.studio | âŒ Private | HLS streams require presigned URLs |" >> $GITHUB_STEP_SUMMARY
          echo "| codex-assets-* | cdn*.revelations.studio | âœ… Public | Thumbnails, logos, avatars |" >> $GITHUB_STEP_SUMMARY
          echo "| codex-resources-* | N/A | âŒ Private | PDFs require presigned URLs |" >> $GITHUB_STEP_SUMMARY
          echo "| codex-platform-* | cdn*.revelations.studio | âœ… Public | Email assets, legal docs |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Media buckets are **private** to protect paid content" >> $GITHUB_STEP_SUMMARY
          echo "- Assets buckets are **public** for fast thumbnail/avatar loading" >> $GITHUB_STEP_SUMMARY
          echo "- All streaming URLs use time-limited presigned URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure wrangler.jsonc files use the correct R2_PUBLIC_URL_BASE values" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy workers to start using the new CDN URLs" >> $GITHUB_STEP_SUMMARY
