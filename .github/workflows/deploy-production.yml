name: Production Deployment

on:
  workflow_run:
    workflows: ["PR and Push CI (Neon ephemeral DB)"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  deployments: write
  issues: write # For failure notifications

concurrency:
  group: production-deployment
  cancel-in-progress: false # Never cancel production deploys mid-flight

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Deploy if: (1) manual trigger OR (2) workflow_run succeeded from push to main
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push' &&
       github.event.workflow_run.head_branch == 'main')
    environment:
      name: production
      url: https://codex.revelations.studio
      # IMPORTANT: Configure required reviewers in GitHub Settings â†’ Environments â†’ production
      # This requires manual approval before any production deployment

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Turborepo local cache for production builds
      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-production-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-production-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-
            ${{ runner.os }}-turbo-production-
            ${{ runner.os }}-turbo-

      # Verify production DNS records exist
      - name: Verify production DNS records
        id: verify-dns
        run: |
          echo "ðŸ” Verifying production DNS configuration..."
          chmod +x .github/scripts/manage-production-dns.sh

          # First verify, if missing then create
          if ! .github/scripts/manage-production-dns.sh verify ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} ${{ secrets.CLOUDFLARE_ZONE_ID }}; then
            echo "âš ï¸  Some DNS records missing, creating them..."
            .github/scripts/manage-production-dns.sh create ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} ${{ secrets.CLOUDFLARE_ZONE_ID }}
          fi

          echo "âœ… Production DNS verified"

      # Build all workers BEFORE touching database
      - name: Build all workers with Turborepo
        run: |
          echo "ðŸ” Validating worker builds before database migration..."
          pnpm build
          echo "âœ… All workers and web app built successfully"
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      # Build @codex/constants before migrations
      - name: Build constants package
        run: pnpm --filter @codex/constants build



      # Apply migrations to production database
      - name: Run production migrations
        id: run-migrations
        run: pnpm --filter @codex/database db:migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_METHOD: ${{ vars.DB_METHOD }}

      - name: Verify migrations applied
        if: steps.run-migrations.outcome == 'success'
        run: echo "âœ… Migrations completed successfully"

      # --- WORKER DEPLOYMENTS ---

      # 1. Media API
      - name: Deploy media-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/media-api
          command: >
            deploy --env production
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}

      - name: Upload media-api secrets
        run: .github/scripts/upload-worker-secrets.sh production media-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          RUNPOD_ENDPOINT_ID: ${{ secrets.RUNPOD_ENDPOINT_ID }}
          RUNPOD_WEBHOOK_SECRET: ${{ secrets.RUNPOD_WEBHOOK_SECRET }}
          WORKER_SHARED_SECRET: ${{ secrets.WORKER_SHARED_SECRET }}
          B2_ENDPOINT: ${{ secrets.B2_ENDPOINT }}
          B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
          B2_APP_KEY: ${{ secrets.B2_APP_KEY }}
          B2_BUCKET: ${{ secrets.B2_BUCKET }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # 2. Ecom API
      - name: Deploy ecom-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/ecom-api
          command: >
            deploy --env production
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}

      - name: Upload ecom-api secrets
        run: .github/scripts/upload-worker-secrets.sh production ecom-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET_PAYMENT: ${{ secrets.STRIPE_WEBHOOK_SECRET_PAYMENT }}
          STRIPE_WEBHOOK_SECRET_SUBSCRIPTION: ${{ secrets.STRIPE_WEBHOOK_SECRET_SUBSCRIPTION }}
          STRIPE_WEBHOOK_SECRET_CONNECT: ${{ secrets.STRIPE_WEBHOOK_SECRET_CONNECT }}
          STRIPE_WEBHOOK_SECRET_CUSTOMER: ${{ secrets.STRIPE_WEBHOOK_SECRET_CUSTOMER }}
          STRIPE_WEBHOOK_SECRET_BOOKING: ${{ secrets.STRIPE_WEBHOOK_SECRET_BOOKING }}
          STRIPE_WEBHOOK_SECRET_DISPUTE: ${{ secrets.STRIPE_WEBHOOK_SECRET_DISPUTE }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # 3. Content API
      - name: Deploy content-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/content-api
          command: >
            deploy --env production
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}

      - name: Upload content-api secrets
        run: .github/scripts/upload-worker-secrets.sh production content-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # 4. Identity API
      - name: Deploy identity-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/identity-api
          command: >
            deploy --env production
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}

      - name: Upload identity-api secrets
        run: .github/scripts/upload-worker-secrets.sh production identity-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # 5. Admin API
      - name: Deploy admin-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/admin-api
          command: >
            deploy --env production
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}

      - name: Upload admin-api secrets
        run: .github/scripts/upload-worker-secrets.sh production admin-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # 6. Organization API
      - name: Deploy organization-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/organization-api
          command: >
            deploy --env production
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}

      - name: Upload organization-api secrets
        run: .github/scripts/upload-worker-secrets.sh production organization-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # 7. Notifications API
      - name: Deploy notifications-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/notifications-api
          command: >
            deploy --env production
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}

      - name: Upload notifications-api secrets
        run: .github/scripts/upload-worker-secrets.sh production notifications-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # 8. Auth Worker
      - name: Deploy auth-worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/auth
          command: >
            deploy --env production
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}

      - name: Upload auth-worker secrets
        run: .github/scripts/upload-worker-secrets.sh production auth
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # 9. Web App
      - name: Build SvelteKit app
        run: pnpm build:web
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PUBLIC_APP_URL: https://codex.revelations.studio
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      - name: Deploy SvelteKit
        id: deploy-web
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/web
          command: deploy --env production

      - name: Upload web secrets
        run: |
          echo '{"DATABASE_URL":"${{ secrets.DATABASE_URL }}"}' | npx wrangler secret bulk --name codex-web-production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # --- POST-DEPLOYMENT VERIFICATION ---

      - name: Comprehensive smoke tests
        timeout-minutes: 5
        run: |
          echo "ðŸ§ª Running comprehensive smoke tests on all services..."
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ª Production Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=0

          # Function to check health
          check_health() {
            local service_name=$1
            local url=$2
            echo "Testing $service_name ($url)..."

            # Use curl to get status code, follow redirects, match 200
            if curl -L -f -s "$url" > /dev/null 2>&1; then
              echo "âœ… $service_name" >> $GITHUB_STEP_SUMMARY
              return 0
            else
              echo "âŒ $service_name ($url)" >> $GITHUB_STEP_SUMMARY
              return 1
            fi
          }

          # Wait for propagation (initial delay)
          echo "â³ Waiting 30s for partial propagation..."
          sleep 30

          # Test all endpoints
          check_health "Media API" "https://media-api.revelations.studio/health" || FAILED=1
          check_health "Ecom API" "https://ecom-api.revelations.studio/health" || FAILED=1
          check_health "Content API" "https://content-api.revelations.studio/health" || FAILED=1
          check_health "Identity API" "https://identity-api.revelations.studio/health" || FAILED=1
          check_health "Organization API" "https://organization-api.revelations.studio/health" || FAILED=1
          check_health "Notifications API" "https://notifications-api.revelations.studio/health" || FAILED=1
          check_health "Admin API" "https://admin-api.revelations.studio/health" || FAILED=1
          check_health "Auth Worker" "https://auth.revelations.studio/health" || FAILED=1
          check_health "Web App" "https://codex.revelations.studio/" || FAILED=1

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $FAILED -eq 0 ]; then
            echo "âœ… **All services passed smoke tests**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ **Some services failed smoke tests**" >> $GITHUB_STEP_SUMMARY
            # Don't fail the build immediately, allow notification to run
            exit 1
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Deployed Services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | [codex.revelations.studio](https://codex.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Media API | [media-api.revelations.studio](https://media-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Ecom API | [ecom-api.revelations.studio](https://ecom-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Content API | [content-api.revelations.studio](https://content-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Identity API | [identity-api.revelations.studio](https://identity-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Organization API | [organization-api.revelations.studio](https://organization-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Notifications API | [notifications-api.revelations.studio](https://notifications-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin API | [admin-api.revelations.studio](https://admin-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Auth | [auth.revelations.studio](https://auth.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
