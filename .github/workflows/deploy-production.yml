name: Production Deployment

on:
  workflow_run:
    workflows: ["PR and Push CI (Neon ephemeral DB)"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  deployments: write
  issues: write # For failure notifications

concurrency:
  group: production-deployment
  cancel-in-progress: false # Never cancel production deploys mid-flight

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Deploy if: (1) manual trigger OR (2) workflow_run succeeded from push to main
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'push' &&
       github.event.workflow_run.head_branch == 'main')
    environment:
      name: production
      url: https://codex.revelations.studio
      # IMPORTANT: Configure required reviewers in GitHub Settings ‚Üí Environments ‚Üí production
      # This requires manual approval before any production deployment

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Turborepo local cache for production builds
      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-production-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-production-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-
            ${{ runner.os }}-turbo-production-
            ${{ runner.os }}-turbo-

      # Verify production DNS records exist
      # NOTE: While Cloudflare Workers custom domains handle routing, the underlying
      # DNS records must exist first. This step verifies all required DNS records are
      # in place, and creates them if missing (only on first deployment).
      # After initial setup, this step will just verify and pass quickly.
      - name: Verify production DNS records
        id: verify-dns
        run: |
          echo "üîç Verifying production DNS configuration..."
          chmod +x .github/scripts/manage-production-dns.sh

          # First verify, if missing then create
          if ! .github/scripts/manage-production-dns.sh verify ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} ${{ secrets.CLOUDFLARE_ZONE_ID }}; then
            echo "‚ö†Ô∏è  Some DNS records missing, creating them..."
            .github/scripts/manage-production-dns.sh create ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} ${{ secrets.CLOUDFLARE_ZONE_ID }}
          fi

          echo "‚úÖ Production DNS verified"

      # Pre-deployment validation: Build all workers BEFORE touching database
      # Using Turborepo for parallel builds and caching
      - name: Validate all workers build successfully with Turborepo
        run: |
          echo "üîç Validating worker builds before database migration..."
          # Build all workers and the web app in parallel using Turborepo
          pnpm build
          echo "‚úÖ All workers and web app built successfully"
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      # Test migrations on a temporary branch first (dry run)
      - name: Test migrations on temporary Neon branch
        id: test-migration
        run: |
          echo "üß™ Testing migrations on temporary branch..."

          # Create temporary test branch
          TEMP_BRANCH_NAME="migration-test-$(date +%s)"
          echo "Creating temporary branch: $TEMP_BRANCH_NAME"

          # Note: This requires neonctl CLI. Install it if not available:
          # npm install -g neonctl

          # For now, we'll skip this test in CI and rely on ephemeral branch testing
          # TODO: Add neonctl and implement full dry-run testing
          echo "‚ö†Ô∏è Dry-run testing not implemented yet - relying on test workflow validation"
          echo "‚úÖ Proceeding with migration (validated in test workflow)"

      # Apply migrations to production database
      # Uses DATABASE_URL from production environment secrets
      - name: Run production migrations
        id: run-migrations
        run: pnpm --filter @codex/database db:migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DB_METHOD: ${{ vars.DB_METHOD }}

      # Verify migration success
      - name: Verify migrations applied successfully
        if: steps.run-migrations.outcome == 'success'
        run: |
          echo "‚úÖ Migrations completed successfully"
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      # Deploy ecom-api to production
      - name: Deploy ecom-api
        id: deploy-ecom
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/ecom-api
          command: deploy --env production

      # Upload secrets to the production worker
      - name: Upload ecom-api secrets
        run: .github/scripts/upload-worker-secrets.sh production ecom-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET_PAYMENT: ${{ secrets.STRIPE_WEBHOOK_SECRET_PAYMENT }}
          STRIPE_WEBHOOK_SECRET_SUBSCRIPTION: ${{ secrets.STRIPE_WEBHOOK_SECRET_SUBSCRIPTION }}
          STRIPE_WEBHOOK_SECRET_CONNECT: ${{ secrets.STRIPE_WEBHOOK_SECRET_CONNECT }}
          STRIPE_WEBHOOK_SECRET_CUSTOMER: ${{ secrets.STRIPE_WEBHOOK_SECRET_CUSTOMER }}
          STRIPE_WEBHOOK_SECRET_BOOKING: ${{ secrets.STRIPE_WEBHOOK_SECRET_BOOKING }}
          STRIPE_WEBHOOK_SECRET_DISPUTE: ${{ secrets.STRIPE_WEBHOOK_SECRET_DISPUTE }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # Verify API worker is healthy after deployment
      - name: Health check - API worker
        timeout-minutes: 5
        run: |
          echo "üè• Checking API worker health at https://api.revelations.studio..."

          # Wait for custom domain SSL to provision (can take 30-90 seconds)
          echo "‚è≥ Waiting for SSL certificate provisioning..."
          sleep 30

          # Retry health check with exponential backoff
          MAX_RETRIES=10
          RETRY_COUNT=0
          RETRY_DELAY=5

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://api.revelations.studio/health || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ API worker is healthy (HTTP $HTTP_CODE)"
              exit 0
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "‚è≥ Connection failed (SSL provisioning?), retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            else
              echo "‚è≥ API returned HTTP $HTTP_CODE, retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            fi

            sleep $RETRY_DELAY
            RETRY_COUNT=$((RETRY_COUNT + 1))
            RETRY_DELAY=$((RETRY_DELAY * 2)) # Exponential backoff
          done

          echo "‚ùå API worker health check failed after $MAX_RETRIES attempts"
          echo "Last HTTP code: $HTTP_CODE"
          exit 1

      # Deploy content-api to production
      - name: Deploy content-api
        id: deploy-content-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/content-api
          command: deploy --env production

      - name: Upload content-api secrets
        run: .github/scripts/upload-worker-secrets.sh production content-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # Verify content-api worker is healthy after deployment
      - name: Health check - Content API worker
        timeout-minutes: 5
        run: |
          echo "üè• Checking Content API worker health at https://content-api.revelations.studio..."

          # Wait for custom domain SSL
          echo "‚è≥ Waiting for SSL certificate..."
          sleep 15

          MAX_RETRIES=10
          RETRY_COUNT=0
          RETRY_DELAY=5

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://content-api.revelations.studio/health || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Content API worker is healthy (HTTP $HTTP_CODE)"
              exit 0
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "‚è≥ Connection failed (SSL provisioning?), retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            else
              echo "‚è≥ Content API returned HTTP $HTTP_CODE, retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            fi

            sleep $RETRY_DELAY
            RETRY_COUNT=$((RETRY_COUNT + 1))
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done

          echo "‚ùå Content API worker health check failed after $MAX_RETRIES attempts"
          echo "Last HTTP code: $HTTP_CODE"
          exit 1

      # Deploy identity-api to production
      - name: Deploy identity-api
        id: deploy-identity-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/identity-api
          command: deploy --env production

      - name: Upload identity-api secrets
        run: .github/scripts/upload-worker-secrets.sh production identity-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # Verify identity-api worker is healthy after deployment
      - name: Health check - Identity API worker
        timeout-minutes: 5
        run: |
          echo "üè• Checking Identity API worker health at https://identity-api.revelations.studio..."

          # Wait for custom domain SSL
          echo "‚è≥ Waiting for SSL certificate..."
          sleep 15

          MAX_RETRIES=10
          RETRY_COUNT=0
          RETRY_DELAY=5

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://identity-api.revelations.studio/health || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Identity API worker is healthy (HTTP $HTTP_CODE)"
              exit 0
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "‚è≥ Connection failed (SSL provisioning?), retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            else
              echo "‚è≥ Identity API returned HTTP $HTTP_CODE, retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            fi

            sleep $RETRY_DELAY
            RETRY_COUNT=$((RETRY_COUNT + 1))
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done

          echo "‚ùå Identity API worker health check failed after $MAX_RETRIES attempts"
          echo "Last HTTP code: $HTTP_CODE"
          exit 1

      # Deploy admin-api to production
      - name: Deploy admin-api
        id: deploy-admin-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/admin-api
          command: deploy --env production

      - name: Upload admin-api secrets
        run: .github/scripts/upload-worker-secrets.sh production admin-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # Verify admin-api worker is healthy after deployment
      - name: Health check - Admin API worker
        timeout-minutes: 5
        run: |
          echo "üè• Checking Admin API worker health at https://admin-api.revelations.studio/health..."

          # Wait for custom domain SSL
          echo "‚è≥ Waiting for SSL certificate..."
          sleep 15

          MAX_RETRIES=10
          RETRY_COUNT=0
          RETRY_DELAY=5

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://admin-api.revelations.studio/health || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Admin API worker is healthy (HTTP $HTTP_CODE)"
              exit 0
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "‚è≥ Connection failed (SSL provisioning?), retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            else
              echo "‚è≥ Admin API returned HTTP $HTTP_CODE, retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            fi

            sleep $RETRY_DELAY
            RETRY_COUNT=$((RETRY_COUNT + 1))
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done

          echo "‚ùå Admin API worker health check failed after $MAX_RETRIES attempts"
          echo "Last HTTP code: $HTTP_CODE"
          exit 1

      # Deploy organization-api to production
      - name: Deploy organization-api
        id: deploy-organization-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/organization-api
          command: deploy --env production

      - name: Upload organization-api secrets
        run: .github/scripts/upload-worker-secrets.sh production organization-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # Verify organization-api worker is healthy after deployment
      - name: Health check - Organization API worker
        timeout-minutes: 5
        run: |
          echo "üè• Checking Organization API worker health at https://organization-api.revelations.studio..."

          # Wait for custom domain SSL
          echo "‚è≥ Waiting for SSL certificate..."
          sleep 15

          MAX_RETRIES=10
          RETRY_COUNT=0
          RETRY_DELAY=5

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://organization-api.revelations.studio/health || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Organization API worker is healthy (HTTP $HTTP_CODE)"
              exit 0
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "‚è≥ Connection failed (SSL provisioning?), retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            else
              echo "‚è≥ Organization API returned HTTP $HTTP_CODE, retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            fi

            sleep $RETRY_DELAY
            RETRY_COUNT=$((RETRY_COUNT + 1))
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done

          echo "‚ùå Organization API worker health check failed after $MAX_RETRIES attempts"
          echo "Last HTTP code: $HTTP_CODE"
          exit 1

      # Deploy notifications-api to production
      - name: Deploy notifications-api
        id: deploy-notifications-api
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/notifications-api
          command: deploy --env production

      - name: Upload notifications-api secrets
        run: .github/scripts/upload-worker-secrets.sh production notifications-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # Verify notifications-api worker is healthy after deployment
      - name: Health check - Notifications API worker
        timeout-minutes: 5
        run: |
          echo "üè• Checking Notifications API worker health at https://notifications-api.revelations.studio..."

          # Wait for custom domain SSL
          echo "‚è≥ Waiting for SSL certificate..."
          sleep 15

          MAX_RETRIES=10
          RETRY_COUNT=0
          RETRY_DELAY=5

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://notifications-api.revelations.studio/health || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Notifications API worker is healthy (HTTP $HTTP_CODE)"
              exit 0
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "‚è≥ Connection failed (SSL provisioning?), retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            else
              echo "‚è≥ Notifications API returned HTTP $HTTP_CODE, retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            fi

            sleep $RETRY_DELAY
            RETRY_COUNT=$((RETRY_COUNT + 1))
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done

          echo "‚ùå Notifications API worker health check failed after $MAX_RETRIES attempts"
          echo "Last HTTP code: $HTTP_CODE"
          exit 1

      # Deploy auth-worker to production
      - name: Deploy auth-worker
        id: deploy-auth
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/auth
          command: deploy --env production

      - name: Upload auth-worker secrets
        run: .github/scripts/upload-worker-secrets.sh production auth
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      # Verify auth worker is healthy after deployment
      - name: Health check - Auth worker
        timeout-minutes: 5
        run: |
          echo "üè• Checking Auth worker health at https://auth.revelations.studio..."

          # Wait for custom domain SSL (shorter wait since API already provisioned)
          echo "‚è≥ Waiting for SSL certificate..."
          sleep 15

          MAX_RETRIES=10
          RETRY_COUNT=0
          RETRY_DELAY=5

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://auth.revelations.studio/health || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Auth worker is healthy (HTTP $HTTP_CODE)"
              exit 0
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "‚è≥ Connection failed (SSL provisioning?), retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            else
              echo "‚è≥ Auth returned HTTP $HTTP_CODE, retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            fi

            sleep $RETRY_DELAY
            RETRY_COUNT=$((RETRY_COUNT + 1))
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done

          echo "‚ùå Auth worker health check failed after $MAX_RETRIES attempts"
          echo "Last HTTP code: $HTTP_CODE"
          exit 1

      # Build SvelteKit app using Turborepo (NOTE: Build was already validated earlier)
      # This rebuild ensures fresh artifacts with production env vars
      - name: Build SvelteKit app for production with Turborepo
        run: pnpm build:web
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PUBLIC_APP_URL: https://codex.revelations.studio
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      # Deploy SvelteKit to production
      - name: Deploy SvelteKit to production
        id: deploy-web
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/web
          command: deploy --env production

      - name: Upload web secrets
        run: |
          echo '{"DATABASE_URL":"${{ secrets.DATABASE_URL }}"}' | npx wrangler secret bulk --name codex-web-production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Verify web app is healthy after deployment
      - name: Health check - Web app
        timeout-minutes: 5
        run: |
          echo "üè• Checking Web app health at https://codex.revelations.studio..."

          # Wait for custom domain SSL
          echo "‚è≥ Waiting for SSL certificate..."
          sleep 15

          MAX_RETRIES=10
          RETRY_COUNT=0
          RETRY_DELAY=5

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # For SvelteKit app, check the homepage (may not have /health endpoint)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://codex.revelations.studio || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Web app is healthy (HTTP $HTTP_CODE)"
              exit 0
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "‚è≥ Connection failed (SSL provisioning?), retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            else
              echo "‚è≥ Web app returned HTTP $HTTP_CODE, retrying in ${RETRY_DELAY}s... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            fi

            sleep $RETRY_DELAY
            RETRY_COUNT=$((RETRY_COUNT + 1))
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done

          echo "‚ùå Web app health check failed after $MAX_RETRIES attempts"
          echo "Last HTTP code: $HTTP_CODE"
          exit 1

      # Comprehensive smoke tests for all 8 services
      - name: Comprehensive smoke tests
        timeout-minutes: 5
        run: |
          echo "üß™ Running comprehensive smoke tests on all services..."
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üß™ Production Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=0

          # Test 1: Stripe Webhook Handler
          echo "Testing Stripe webhook handler..."
          if curl -f -s https://api.revelations.studio/health > /dev/null 2>&1; then
            echo "‚úÖ Stripe webhook handler (api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Stripe webhook handler (api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          # Test 2: Content API
          echo "Testing Content API..."
          if curl -f -s https://content-api.revelations.studio/health > /dev/null 2>&1; then
            echo "‚úÖ Content API (content-api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Content API (content-api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          # Test 3: Identity API
          echo "Testing Identity API..."
          if curl -f -s https://identity-api.revelations.studio/health > /dev/null 2>&1; then
            echo "‚úÖ Identity API (identity-api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Identity API (identity-api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          # Test 4: Organization API
          echo "Testing Organization API..."
          if curl -f -s https://organization-api.revelations.studio/health > /dev/null 2>&1; then
            echo "‚úÖ Organization API (organization-api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Organization API (organization-api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          # Test 5: Notifications API
          echo "Testing Notifications API..."
          if curl -f -s https://notifications-api.revelations.studio/health > /dev/null 2>&1; then
            echo "‚úÖ Notifications API (notifications-api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Notifications API (notifications-api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          # Test 6: Admin API
          echo "Testing Admin API..."
          if curl -f -s https://admin-api.revelations.studio/health > /dev/null 2>&1; then
            echo "‚úÖ Admin API (admin-api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Admin API (admin-api.revelations.studio)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          # Test 7: Auth Worker
          echo "Testing Auth worker..."
          if curl -f -s https://auth.revelations.studio/health > /dev/null 2>&1; then
            echo "‚úÖ Auth worker (auth.revelations.studio)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Auth worker (auth.revelations.studio)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          # Test 8: Web App
          echo "Testing Web app..."
          if curl -f -s https://codex.revelations.studio > /dev/null 2>&1; then
            echo "‚úÖ Web app (codex.revelations.studio)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Web app (codex.revelations.studio)" >> $GITHUB_STEP_SUMMARY
            FAILED=1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ $FAILED -eq 0 ]; then
            echo "‚úÖ **All 8 services passed smoke tests**" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ All smoke tests passed"
            exit 0
          else
            echo "‚ùå **Some services failed smoke tests**" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå Smoke tests failed"
            exit 1
          fi

      - name: Deployment notification with metrics
        if: success()
        run: |
          echo "‚úÖ Production deployment successful"
          echo "üåê Web App: https://codex.revelations.studio - Health: OK"
          echo "üîå API (Stripe): https://api.revelations.studio - Health: OK"
          echo "üìù Content API: https://content-api.revelations.studio - Health: OK"
          echo "üë§ Identity API: https://identity-api.revelations.studio - Health: OK"
          echo "üè¢ Organization API: https://organization-api.revelations.studio - Health: OK"
          echo "üìß Notifications API: https://notifications-api.revelations.studio - Health: OK"
          echo "üõ†Ô∏è Admin API: https://admin-api.revelations.studio - Health: OK"
          echo "üîê Auth: https://auth.revelations.studio - Health: OK"
          echo "üíæ Database: Migrations applied successfully"
          echo "‚ö° All workers deployed and verified healthy"

          # Add prominent URL section at TOP of summary
          echo "## üöÄ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê Deployed Services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Web App | [codex.revelations.studio](https://codex.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Stripe API | [api.revelations.studio](https://api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Content API | [content-api.revelations.studio](https://content-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Identity API | [identity-api.revelations.studio](https://identity-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Organization API | [organization-api.revelations.studio](https://organization-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Notifications API | [notifications-api.revelations.studio](https://notifications-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin API | [admin-api.revelations.studio](https://admin-api.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "| Auth | [auth.revelations.studio](https://auth.revelations.studio) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add deployment metrics
          echo "## ‚ö° Deployment Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** Merged to main" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Completed:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "- **Workers deployed:** 8 (stripe, content, identity, organization, notifications, admin, auth, web)" >> $GITHUB_STEP_SUMMARY
          echo "- **Health checks:** All passed ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Smoke tests:** All passed ‚úÖ" >> $GITHUB_STEP_SUMMARY

      - name: Rollback instructions on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Production Deployment Failed - ${context.sha.substring(0, 7)}`,
              labels: ['production', 'deployment-failure', 'urgent'],
              body: `## Production Deployment Failed

            **Commit**: ${context.sha}
            **Workflow Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            **Timestamp**: ${new Date().toISOString()}

            ### Immediate Actions Required

            #### 1. Check which step failed
            [View workflow logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            #### 2. If migrations failed
            - Database is still on old schema ‚úÖ
            - Workers are still on old version ‚úÖ
            - **No rollback needed** - safe to retry after fixing migrations

            #### 3. If worker deployment failed AFTER migrations
            ‚ö†Ô∏è **CRITICAL**: Database has new schema, but workers expect old schema

            **Manual rollback required**:

            \`\`\`bash
            # Option A: Rollback worker to previous version
            wrangler rollback --name ecom-api-production
            wrangler rollback --name auth-worker-production
            wrangler rollback --name codex-web-production

            # Option B: Restore database from Neon point-in-time
            # Create restore branch from 30 minutes ago
            neonctl branches create \\
              --name emergency-restore-$(date +%s) \\
              --parent production \\
              --timestamp "30 minutes ago"

            # Then redeploy workers pointing to restored branch
            \`\`\`

            #### 4. If health checks failed
            - Workers deployed successfully but not responding
            - Check Cloudflare dashboard for errors
            - Verify DNS is resolving correctly
            - Check worker logs: \`wrangler tail <worker-name>\`

            ### Prevention
            - This workflow now validates builds BEFORE running migrations
            - Health checks verify each worker after deployment
            - Consider adding staged rollout or blue-green deployment

            @${context.actor} please investigate and respond here once resolved.
            `
            });

            console.log('Created issue:', issue.data.html_url);
