name: Preview Deployment

on:
  # Run after tests complete successfully
  workflow_run:
    workflows: ['PR and Push CI (Neon ephemeral DB)']
    types:
      - completed
  # Also run when PR is closed for cleanup
  pull_request:
    types: [closed]
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  deployments: write

concurrency:
  group: preview-${{ github.event.workflow_run.pull_requests[0].number || github.event.pull_request.number || inputs.pr_number }}
  cancel-in-progress: true # Cancel old deployments for same PR

env:
  # Handle workflow_run, pull_request, and workflow_dispatch triggers
  PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number || github.event.pull_request.number || inputs.pr_number }}

jobs:
  # Cleanup preview when PR is closed
  cleanup-preview:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - uses: actions/checkout@v4

      - name: Delete Neon branch
        uses: neondatabase/delete-branch-action@v3
        continue-on-error: true
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch: preview-pr-${{ env.PR_NUMBER }}
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install wrangler
        run: pnpm add -g wrangler

      - name: Delete worker deployments
        continue-on-error: true
        run: |
          wrangler delete --name ecom-api-preview-${{ env.PR_NUMBER }} || true
          wrangler delete --name media-api-preview-${{ env.PR_NUMBER }} || true
          wrangler delete --name content-api-preview-${{ env.PR_NUMBER }} || true
          wrangler delete --name identity-api-preview-${{ env.PR_NUMBER }} || true
          wrangler delete --name organization-api-preview-${{ env.PR_NUMBER }} || true
          wrangler delete --name notifications-api-preview-${{ env.PR_NUMBER }} || true
          wrangler delete --name admin-api-preview-${{ env.PR_NUMBER }} || true
          wrangler delete --name auth-worker-preview-${{ env.PR_NUMBER }} || true
          wrangler delete --name codex-web-preview-${{ env.PR_NUMBER }} || true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Delete preview custom domains
        continue-on-error: true
        run: |
          for domain in \
            "media-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "content-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "identity-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "admin-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "organization-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "notifications-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "auth-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "codex-preview-${{ env.PR_NUMBER }}.revelations.studio"; do
            echo "Deleting $domain..."
            wrangler custom-domains delete "$domain" || echo "Domain $domain may not exist"
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Delete preview DNS records
        continue-on-error: true
        run: |
          chmod +x .github/scripts/manage-preview-dns.sh
          .github/scripts/manage-preview-dns.sh delete ${{ env.PR_NUMBER }} ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} ${{ secrets.CLOUDFLARE_ZONE_ID }}

      - name: Comment cleanup complete
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ env.PR_NUMBER }},
              body: 'üßπ Preview environment cleaned up successfully (9 workers, web app, database branch, 9 custom domains, and 9 DNS records removed).'
            });

  deploy-preview:
    name: Deploy Preview Environment
    runs-on: ubuntu-latest
    # Use preview environment for environment-specific secrets and variables
    environment: preview
    # Deploy if: (1) manual trigger OR (2) workflow_run succeeded and was triggered by PR
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'pull_request')
    outputs:
      web_url: ${{ steps.deploy-web.outputs.deployment-url }}

    steps:
      - name: Debug workflow context
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Event action: ${{ github.event.action }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run event: ${{ github.event.workflow_run.event }}"
          echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
          echo "PR Number: ${{ env.PR_NUMBER }}"
          echo "Has PR requests: ${{ github.event.workflow_run.pull_requests[0] != null }}"

      - uses: actions/checkout@v4

      # Create initial deployment status comment
      - name: Create deployment status comment
        if: github.event_name == 'workflow_run'
        id: create-comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ env.PR_NUMBER }},
              body: `## üöÄ Preview Deployment Started

            **Status:** üîÑ Building
            **Started:** ${new Date().toLocaleString()}

            ### Progress
            - [x] Tests passed ‚úÖ
            - [ ] Building workers...
            - [ ] Deploying to Cloudflare...
            - [ ] Running health checks...
            - [ ] Preview ready

            **Estimated time:** ~5 minutes

            _This comment will update with progress..._`
            });

            return comment.data.id;

      - name: Set comment ID
        if: steps.create-comment.outcome == 'success'
        run: echo "COMMENT_ID=${{ steps.create-comment.outputs.result }}" >> $GITHUB_ENV

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Turborepo local cache for preview builds
      - name: Cache Turborepo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-preview-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-preview-${{ hashFiles('pnpm-lock.yaml', 'turbo.json', '**/package.json') }}-
            ${{ runner.os }}-turbo-preview-
            ${{ runner.os }}-turbo-

      # Pre-deployment quality gates
      - name: Pre-deployment quality gates
        run: |
          echo "## üîç Pre-Deployment Checks" >> $GITHUB_STEP_SUMMARY

          # Verify this workflow_run came from successful tests (if triggered by workflow_run)
          EVENT_NAME="${{ github.event_name }}"
          WORKFLOW_CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          if [ "$EVENT_NAME" == "workflow_run" ] && [ "$WORKFLOW_CONCLUSION" != "success" ]; then
            echo "‚ùå Tests must pass before deploying" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "‚úÖ All quality gates passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Static analysis passed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Safe to deploy" >> $GITHUB_STEP_SUMMARY

      # Build packages using Turborepo (required by workers)
      - name: Build packages with Turborepo
        run: pnpm build:packages
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      # Build workers using Turborepo (required before deployment)
      - name: Build workers with Turborepo
        run: pnpm build:workers
        env:
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      # Update status - Build complete
      - name: Update status - Build complete
        if: env.COMMENT_ID != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: '${{ env.COMMENT_ID }}',
              body: `## üöÄ Preview Deployment In Progress

            **Status:** üîÑ Creating Database
            **Started:** ${new Date().toLocaleString()}

            ### Progress
            - [x] Building workers ‚úÖ
            - [ ] Creating Neon branch...
            - [ ] Deploying to Cloudflare...
            - [ ] Running health checks...
            - [ ] Preview ready

            _Setting up isolated database branch..._`
            });

      # Create Neon branch for this preview deployment
      - name: Create Neon branch for preview
        id: create-neon-branch
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ vars.NEON_PROJECT_ID }}
          branch_name: preview-pr-${{ env.PR_NUMBER }}
          parent: production
          username: neondb_owner
          api_key: ${{ secrets.NEON_API_KEY }}

      # Load DATABASE_URL from Neon branch creation
      - name: Set DATABASE_URL from Neon branch
        run: |
          DATABASE_URL="${{ steps.create-neon-branch.outputs.db_url_with_pooler }}"
          echo "::add-mask::$DATABASE_URL"
          echo "DATABASE_URL=$DATABASE_URL" >> $GITHUB_ENV
          echo "BRANCH_ID=${{ steps.create-neon-branch.outputs.branch_id }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=preview-pr-${{ env.PR_NUMBER }}" >> $GITHUB_ENV
          echo "‚úÖ Database branch created: preview-pr-${{ env.PR_NUMBER }}"

      # Build @codex/constants before migrations (required dependency)
      - name: Build constants package
        run: pnpm --filter @codex/constants build

      # Run database migrations on the preview branch
      - name: Run migrations on preview branch
        run: pnpm --filter @codex/database db:migrate
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          DB_METHOD: NEON_BRANCH

      # Create DNS records for preview deployment
      - name: Create preview DNS records
        id: dns-creation
        run: |
          echo "üåê Creating DNS records for preview-${{ env.PR_NUMBER }}..."
          chmod +x .github/scripts/manage-preview-dns.sh
          .github/scripts/manage-preview-dns.sh create ${{ env.PR_NUMBER }} ${{ secrets.CLOUDFLARE_DNS_API_TOKEN }} ${{ secrets.CLOUDFLARE_ZONE_ID }}

      # Verify DNS propagation
      - name: Verify DNS propagation
        timeout-minutes: 2
        run: |
          echo "‚è≥ Waiting for DNS propagation..."
          for i in {1..30}; do
            if dig +short codex-preview-${{ env.PR_NUMBER }}.revelations.studio | grep -q .; then
              echo "‚úÖ DNS propagated successfully after ${i} attempts"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ö†Ô∏è DNS propagation timeout - continuing anyway (might still work)"
              break
            fi
            echo "Waiting for DNS propagation... ($i/30)"
            sleep 2
          done

      # Register custom domains for worker routing
      - name: Register preview custom domains
        run: |
          echo "üîê Registering custom domains for preview-${{ env.PR_NUMBER }}..."
          for domain in \
            "media-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "content-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "identity-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "admin-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "organization-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "notifications-api-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "auth-preview-${{ env.PR_NUMBER }}.revelations.studio" \
            "codex-preview-${{ env.PR_NUMBER }}.revelations.studio"; do
            echo "Registering $domain..."
            wrangler custom-domains create "$domain" || echo "Domain $domain may already exist"
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # --- WORKER DEPLOYMENTS (using shared upload script) ---

      # 1. Ecom API
      - name: Deploy ecom-api (preview)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/ecom-api
          command: >
            deploy --name ecom-api-preview-${{ env.PR_NUMBER }}
            --var ENVIRONMENT:preview
            --var DB_METHOD:NEON_BRANCH
            --var WEB_APP_URL:https://codex-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var API_URL:https://ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}
            --route "ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio/*"

      - name: Upload ecom-api secrets
        run: .github/scripts/upload-worker-secrets.sh preview ecom-api ecom-api-preview-${{ env.PR_NUMBER }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET_PAYMENT: ${{ secrets.STRIPE_WEBHOOK_SECRET_PAYMENT }}
          STRIPE_WEBHOOK_SECRET_SUBSCRIPTION: ${{ secrets.STRIPE_WEBHOOK_SECRET_SUBSCRIPTION }}
          STRIPE_WEBHOOK_SECRET_CONNECT: ${{ secrets.STRIPE_WEBHOOK_SECRET_CONNECT }}
          STRIPE_WEBHOOK_SECRET_CUSTOMER: ${{ secrets.STRIPE_WEBHOOK_SECRET_CUSTOMER }}
          STRIPE_WEBHOOK_SECRET_BOOKING: ${{ secrets.STRIPE_WEBHOOK_SECRET_BOOKING }}
          STRIPE_WEBHOOK_SECRET_DISPUTE: ${{ secrets.STRIPE_WEBHOOK_SECRET_DISPUTE }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      - name: Set API URL
        run: |
          API_URL="https://ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio"
          echo "API_URL=$API_URL" >> $GITHUB_ENV

      # 2. Media API
      - name: Deploy media-api (preview)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/media-api
          command: >
            deploy --name media-api-preview-${{ env.PR_NUMBER }}
            --var ENVIRONMENT:preview
            --var DB_METHOD:NEON_BRANCH
            --var WEB_APP_URL:https://codex-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var API_URL:https://ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}
            --route "media-api-preview-${{ env.PR_NUMBER }}.revelations.studio/*"

      - name: Upload media-api secrets
        run: .github/scripts/upload-worker-secrets.sh preview media-api media-api-preview-${{ env.PR_NUMBER }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
          RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
          RUNPOD_ENDPOINT_ID: ${{ secrets.RUNPOD_ENDPOINT_ID }}
          RUNPOD_WEBHOOK_SECRET: ${{ secrets.RUNPOD_WEBHOOK_SECRET }}
          WORKER_SHARED_SECRET: ${{ secrets.WORKER_SHARED_SECRET }}
          B2_ENDPOINT: ${{ secrets.B2_ENDPOINT }}
          B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
          B2_APP_KEY: ${{ secrets.B2_APP_KEY }}
          B2_BUCKET: ${{ secrets.B2_BUCKET }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      - name: Set Media API URL
        run: |
          MEDIA_API_URL="https://media-api-preview-${{ env.PR_NUMBER }}.revelations.studio"
          echo "MEDIA_API_URL=$MEDIA_API_URL" >> $GITHUB_ENV

      # 3. Content API
      - name: Deploy content-api (preview)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/content-api
          command: >
            deploy --name content-api-preview-${{ env.PR_NUMBER }}
            --var ENVIRONMENT:preview
            --var DB_METHOD:NEON_BRANCH
            --var WEB_APP_URL:https://codex-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var API_URL:https://ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}
            --route "content-api-preview-${{ env.PR_NUMBER }}.revelations.studio/*"

      - name: Upload content-api secrets
        run: .github/scripts/upload-worker-secrets.sh preview content-api content-api-preview-${{ env.PR_NUMBER }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      - name: Set Content API URL
        run: |
          CONTENT_API_URL="https://content-api-preview-${{ env.PR_NUMBER }}.revelations.studio"
          echo "CONTENT_API_URL=$CONTENT_API_URL" >> $GITHUB_ENV

      # 4. Identity API
      - name: Deploy identity-api (preview)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/identity-api
          command: >
            deploy --name identity-api-preview-${{ env.PR_NUMBER }}
            --var ENVIRONMENT:preview
            --var DB_METHOD:NEON_BRANCH
            --var WEB_APP_URL:https://codex-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var API_URL:https://ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}
            --route "identity-api-preview-${{ env.PR_NUMBER }}.revelations.studio/*"

      - name: Upload identity-api secrets
        run: .github/scripts/upload-worker-secrets.sh preview identity-api identity-api-preview-${{ env.PR_NUMBER }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      - name: Set Identity API URL
        run: |
          IDENTITY_API_URL="https://identity-api-preview-${{ env.PR_NUMBER }}.revelations.studio"
          echo "IDENTITY_API_URL=$IDENTITY_API_URL" >> $GITHUB_ENV

      # 5. Admin API
      - name: Deploy admin-api (preview)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/admin-api
          command: >
            deploy --name admin-api-preview-${{ env.PR_NUMBER }}
            --var ENVIRONMENT:preview
            --var DB_METHOD:NEON_BRANCH
            --var WEB_APP_URL:https://codex-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var API_URL:https://ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var AUTH_WORKER_URL:https://auth-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}
            --route "admin-api-preview-${{ env.PR_NUMBER }}.revelations.studio/*"

      - name: Upload admin-api secrets
        run: .github/scripts/upload-worker-secrets.sh preview admin-api admin-api-preview-${{ env.PR_NUMBER }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      - name: Set Admin API URL
        run: |
          ADMIN_API_URL="https://admin-api-preview-${{ env.PR_NUMBER }}.revelations.studio"
          echo "ADMIN_API_URL=$ADMIN_API_URL" >> $GITHUB_ENV

      # 6. Organization API
      - name: Deploy organization-api (preview)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/organization-api
          command: >
            deploy --name organization-api-preview-${{ env.PR_NUMBER }}
            --var ENVIRONMENT:preview
            --var DB_METHOD:NEON_BRANCH
            --var WEB_APP_URL:https://codex-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var API_URL:https://ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}
            --route "organization-api-preview-${{ env.PR_NUMBER }}.revelations.studio/*"

      - name: Upload organization-api secrets
        run: .github/scripts/upload-worker-secrets.sh preview organization-api organization-api-preview-${{ env.PR_NUMBER }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      - name: Set Organization API URL
        run: |
          ORGANIZATION_API_URL="https://organization-api-preview-${{ env.PR_NUMBER }}.revelations.studio"
          echo "ORGANIZATION_API_URL=$ORGANIZATION_API_URL" >> $GITHUB_ENV

      # 7. Notifications API
      - name: Deploy notifications-api (preview)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/notifications-api
          command: >
            deploy --name notifications-api-preview-${{ env.PR_NUMBER }}
            --var ENVIRONMENT:preview
            --var DB_METHOD:NEON_BRANCH
            --var WEB_APP_URL:https://codex-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var API_URL:https://ecom-api-preview-${{ env.PR_NUMBER }}.revelations.studio
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}
            --route "notifications-api-preview-${{ env.PR_NUMBER }}.revelations.studio/*"

      - name: Upload notifications-api secrets
        run: .github/scripts/upload-worker-secrets.sh preview notifications-api notifications-api-preview-${{ env.PR_NUMBER }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      - name: Set Notifications API URL
        run: |
          NOTIFICATIONS_API_URL="https://notifications-api-preview-${{ env.PR_NUMBER }}.revelations.studio"
          echo "NOTIFICATIONS_API_URL=$NOTIFICATIONS_API_URL" >> $GITHUB_ENV

      # 8. Set web URL first (needed for auth worker)
      - name: Set Web URL
        run: |
          WEB_URL="https://codex-preview-${{ env.PR_NUMBER }}.revelations.studio"
          echo "WEB_URL=$WEB_URL" >> $GITHUB_ENV

      # 9. Deploy auth worker
      - name: Deploy auth-worker (preview)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers/auth
          command: >
            deploy --name auth-worker-preview-${{ env.PR_NUMBER }}
            --var ENVIRONMENT:preview
            --var DB_METHOD:NEON_BRANCH
            --var API_URL:${{ env.API_URL }}
            --var WEB_APP_URL:${{ env.WEB_URL }}
            --var R2_BUCKET_MEDIA:${{ vars.R2_BUCKET_MEDIA }}
            --var R2_BUCKET_ASSETS:${{ vars.R2_BUCKET_ASSETS }}
            --var R2_BUCKET_PLATFORM:${{ vars.R2_BUCKET_PLATFORM }}
            --var R2_BUCKET_RESOURCES:${{ vars.R2_BUCKET_RESOURCES }}
            --route "auth-preview-${{ env.PR_NUMBER }}.revelations.studio/*"

      - name: Upload auth-worker secrets
        run: .github/scripts/upload-worker-secrets.sh preview auth auth-worker-preview-${{ env.PR_NUMBER }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          DATABASE_URL: ${{ env.DATABASE_URL }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          R2_BUCKET_MEDIA: ${{ vars.R2_BUCKET_MEDIA }}
          R2_BUCKET_ASSETS: ${{ vars.R2_BUCKET_ASSETS }}
          R2_BUCKET_PLATFORM: ${{ vars.R2_BUCKET_PLATFORM }}
          R2_BUCKET_RESOURCES: ${{ vars.R2_BUCKET_RESOURCES }}

      - name: Set Auth URL
        run: |
          AUTH_URL="https://auth-preview-${{ env.PR_NUMBER }}.revelations.studio"
          echo "AUTH_URL=$AUTH_URL" >> $GITHUB_ENV

      # Build and deploy SvelteKit app
      - name: Build SvelteKit app with Turborepo
        run: pnpm build:web
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          DB_METHOD: NEON_BRANCH
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
          TURBO_TEAM: ${{ vars.TURBO_TEAM }}
          TURBO_LOG_VERBOSITY: info

      - name: Deploy SvelteKit (preview)
        id: deploy-web
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/web
          command: >
            deploy --name codex-web-preview-${{ env.PR_NUMBER }}
            --var ENVIRONMENT:preview
            --var DB_METHOD:NEON_BRANCH
            --var AUTH_WORKER_URL:${{ env.AUTH_URL }}
            --var API_URL:${{ env.API_URL }}
            --route "codex-preview-${{ env.PR_NUMBER }}.revelations.studio/*"

      - name: Upload web secrets
        run: |
          echo '{"DATABASE_URL":"${{ env.DATABASE_URL }}"}' | npx wrangler secret bulk --name codex-web-preview-${{ env.PR_NUMBER }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Comment final status on PR
      - name: Comment final status
        if: always() && github.event_name == 'workflow_run' && github.event.workflow_run.pull_requests[0].number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ env.PR_NUMBER }};
            const success = '${{ job.status }}' === 'success';
            const emoji = success ? 'üéâ' : 'üí•';
            const status = success ? 'Complete' : 'Failed';

            let body = `## ${emoji} Preview Deployment ${status}

            **Status:** ${success ? '‚úÖ' : '‚ùå'} ${status}
            **Completed:** ${new Date().toLocaleString()}

            ### Progress
            - [x] Tests passed ‚úÖ
            - [x] Building workers ‚úÖ
            - [x] Deploying to Cloudflare ‚úÖ
            - ${success ? '[x]' : '[ ]'} Running health checks ${success ? '‚úÖ' : '‚ùå'}
            - ${success ? '[x]' : '[ ]'} Preview ready ${success ? '‚úÖ' : ''}`;

            if (success) {
              body += `

            ### üåê Preview URLs
            - **Web App:** https://codex-preview-${prNumber}.revelations.studio
            - **Media API:** https://media-api-preview-${prNumber}.revelations.studio
            - **Ecom API:** https://ecom-api-preview-${prNumber}.revelations.studio
            - **Content API:** https://content-api-preview-${prNumber}.revelations.studio
            - **Identity API:** https://identity-api-preview-${prNumber}.revelations.studio
            - **Organization API:** https://organization-api-preview-${prNumber}.revelations.studio
            - **Notifications API:** https://notifications-api-preview-${prNumber}.revelations.studio
            - **Admin API:** https://admin-api-preview-${prNumber}.revelations.studio
            - **Auth:** https://auth-preview-${prNumber}.revelations.studio
            - **Database:** Neon branch \`${{ env.BRANCH_NAME }}\`

            ### ‚úÖ All Health Checks Passed
            All 8 services are healthy and responding

            ### Testing Checklist
            - [ ] Visual confirmation of UI changes
            - [ ] Test user flows end-to-end
            - [ ] Verify database operations
            - [ ] Check worker functionality

            **Ready for testing!** üöÄ`;
            } else {
              body += `

            ### üîç Troubleshooting
            [View workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            }

            // Update existing comment if we have ID, otherwise create new
            if ('${{ env.COMMENT_ID }}' !== '') {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: '${{ env.COMMENT_ID }}',
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            }
