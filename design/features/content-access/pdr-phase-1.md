# Content Access - Phase 1 PRD

## Feature Summary

This feature provides customers with the interface to access and consume their purchased content. It includes the customer's content library, secure media players for video and audio, and the critical access control logic that ensures only authorized users can view content.

**Key Concept**: After a purchase is confirmed by the E-Commerce feature, the Content Access feature takes over, presenting the content to the user in a secure, high-quality player and tracking their progress.

## Problem Statement

Once a customer purchases content, they need a clear, immediate, and reliable way to view it. The platform must:
- Present all purchased content in an organized library.
- Provide a high-quality streaming experience for video and audio that works on all devices.
- Secure the content so that only the paying customer can access it.
- Prevent unauthorized sharing of direct media links.

Without this feature, a purchase is meaningless as the customer would have no way to consume the product they bought.

## Goals / Success Criteria

### Primary Goals
1.  **Customer Content Library**: Provide a single page where customers can see and access all their purchased content.
2.  **Secure Video Playback**: Implement a secure video player that streams HLS content from R2 using signed URLs.
3.  **Audio Playback**: Implement a player for listening to purchased audio tracks.
4.  **Robust Access Control**: Ensure that only authenticated users with a valid purchase record can access content.
5.  **Resume Playback**: Track and save a user's playback position in videos and audio so they can resume later.

### Success Metrics
- 99.9% of access attempts by authorized users are successful.
- 100% of access attempts by unauthorized users are blocked.
- Video/audio playback starts in < 3 seconds on a standard broadband connection.
- Playback position is saved accurately, with less than 15 seconds of drift.
- The customer library page loads in < 1 second.

## Scope

### In Scope (Phase 1 MVP)
- **Customer Library Page**:
  - A grid/list view of all purchased content items.
  - Displays thumbnail, title, and description.
  - Basic search by title.
- **Video Player**:
  - Use of a production-ready player like Mux Player to handle HLS streaming.
  - Controls: play/pause, volume, fullscreen, quality selection.
  - Playback position is saved every 15 seconds.
  - Player loads with the last saved position.
- **Audio Player**:
  - Basic HTML5 audio player with custom styling.
  - Controls: play/pause, volume, seek bar.
  - Resume playback functionality.
- **Access Control Logic**:
  - Server-side check on page load to verify a valid, non-refunded purchase exists for the user and content.
  - Redirection to the purchase page if access is denied.
- **Secure Streaming**:
  - Media URLs (for HLS playlists, audio files, etc.) are not exposed directly.
  - The backend generates short-lived, signed URLs for Cloudflare R2 on demand.

### Explicitly Out of Scope (Future Phases)
- **Content Comments & Ratings** (Phase 4)
- **Downloading Content / Offline Access** (Phase 4)
- **DRM Encryption** (Phase 4)
- **Community Features** (forums, etc.) (Phase 4)
- **Creating and sharing playlists** (Future)
- **Certificates of Completion** (Phase 4)

## Cross-Feature Dependencies

### E-Commerce Feature (Phase 1)
**Dependency**: This feature is the source of truth for access rights.
- Content Access reads from the `purchases` table to verify a user has paid for content.
- A completed purchase record is required to view content.

### Auth Feature (Phase 1)
**Dependency**: A user must be authenticated to view their library or access any content.
- Relies on `event.locals.user` being populated.

### Content Management Feature (Phase 1)
**Dependency**: Provides the metadata for the content being displayed.
- Displays the `title`, `description`, `thumbnail_url`, etc., from the `content` table.

### Media Transcoding Feature (Phase 1)
**Dependency**: Provides the streamable media files.
- The video player will consume the HLS (`.m3u8`) playlists generated by the transcoding process.
- The audio player will consume the HLS audio streams generated by the transcoding process.

**Note**: This implies an update to the `Media Transcoding` feature to generate HLS streams for audio files as well.

---

## User Stories & Use Cases

### US-ACCESS-001: View Content Library
**As a** Customer,
**I want to** see all the content I have purchased in a single, organized library,
**so that** I can easily find and access what I own.

**Acceptance Criteria:**
- A `/library` page exists and is only accessible to logged-in users.
- The page displays a card for each piece of content for which a valid purchase record exists.
- Each card shows the content thumbnail and title.
- Clicking a card navigates the user to the corresponding content player page.
- A search bar allows filtering the library by content title.

### US-ACCESS-002: Watch Purchased Video
**As a** Customer,
**I want to** watch the videos I have purchased in a high-quality player,
**so that** I can consume the content I paid for.

**Flow:**
1.  Customer clicks on a video in their library.
2.  They are navigated to `/content/[id]`.
3.  The server checks if the user has a valid purchase for this `id`.
4.  If yes, the page loads with the video player.
5.  The player requests a secure media URL from the backend.
6.  The backend generates a short-lived signed URL for the R2 HLS playlist.
7.  The player begins streaming the video.

**Acceptance Criteria:**
- Playback is smooth with adaptive bitrate streaming.
- The player includes standard controls (play, pause, volume, fullscreen).
- The direct `.m3u8` URL is not publicly exposed.

### US-ACCESS-003: Resume Playback
**As a** Customer,
**I want** the player to remember where I left off in a video,
**so that** I can easily resume watching later.

**Flow:**
1.  While a user is watching a video, the frontend sends their current playback time to the backend every 15 seconds.
2.  The backend saves this `position_seconds` in the `video_playback` table, linked to the `userId` and `contentId`.
3.  When the user re-visits the video page, the server retrieves this last known position.
4.  The player is initialized to start at the saved time.

**Acceptance Criteria:**
- Player automatically seeks to the last saved position on load.
- A "Continue Watching" section could appear in the library for items with partial progress.

### US-ACCESS-004: Prevent Unauthorized Access
**As a** System,
**I want to** prevent users from accessing content they haven't purchased,
**so that** the creator's content is protected.

**Flow:**
1.  A user attempts to navigate directly to `/content/[paid_content_id]`.
2.  The server-side `load` function for the page executes.
3.  It checks for an authenticated user. If none, redirect to `/login`.
4.  It queries the `purchases` table for a `completed` purchase for the current user and content ID.
5.  If no record is found, the user is redirected to a sales page for that content.
6.  If a record is found, the page is rendered.

**Acceptance Criteria:**
- A user cannot view a paid content page without a valid purchase.
- A user who has had their purchase refunded can no longer access the content.

---

## Related Documents

- **TDD**: [Content Access Technical Design](./ttd-dphase-1.md)
- **Cross-Feature Dependencies**:
  - [E-Commerce PRD](../e-commerce/pdr-phase-1.md)
  - [Auth PRD](../auth/pdr-phase-1.md)
  - [Media Transcoding PRD](../media-transcoding/pdr-phase-1.md)
- **Infrastructure**:
  - [Database Schema](../../infrastructure/DatabaseSchema.md)
