# Cross-Feature Dependencies

This document centralizes the dependencies between different features of the Codex platform for Phase 1. Each feature's section lists the other features it depends on and for what reason.

---

## 1. Admin Dashboard

### Depends on: Auth
- **Reason**: Restricts access to Platform Owners only.
- **Implementation**: Uses `requireOwner()` guard for all admin routes.

### Depends on: Content Management
- **Reason**: Provides content data for listing, management, and stats.
- **Implementation**: Reads from `content` and `media_items` tables; links to Content Management UIs.

### Depends on: E-Commerce
- **Reason**: Provides purchase and revenue data for analytics.
- **Implementation**: Reads from `purchases` table.

### Depends on: Platform Settings
- **Reason**: Provides data for branding and business information.
- **Implementation**: Reads and writes to the `platform_settings` table.

---

## 2. Auth (Authentication & Authorization)

### Depends on: Notifications
- **Reason**: Sends transactional emails for verification and password resets.
- **Implementation**: Calls `notificationService.sendEmail()` abstraction.

### Depends on: Admin Dashboard
- **Reason**: Redirects Platform Owners to the admin dashboard upon login.
- **Implementation**: Role-based redirect logic.

---

## 3. Content Access

### Depends on: E-Commerce
- **Reason**: Verifies a user has purchased content before granting access.
- **Implementation**: Reads from the `purchases` table to check for a valid, non-refunded purchase.

### Depends on: Auth
- **Reason**: Requires an authenticated user to view their library or access content.
- **Implementation**: Relies on `event.locals.user` being populated.

### Depends on: Content Management
- **Reason**: Provides the metadata (title, description, etc.) for the content being displayed.
- **Implementation**: Reads from the `content` and `media_items` tables.

### Depends on: Media Transcoding
- **Reason**: Consumes the streamable HLS media files.
- **Implementation**: Video and audio players use the `.m3u8` playlists generated by the transcoding process.

---

## 4. Content Management

### Depends on: Media Transcoding
- **Reason**: Triggers the conversion of uploaded videos to HLS format.
- **Implementation**: Enqueues a job to `TRANSCODING_QUEUE` after a video is uploaded.

### Depends on: E-Commerce
- **Reason**: Provides the pricing information for content.
- **Implementation**: The `content` table has a `price` field used by the E-Commerce feature.

### Depends on: Content Access
- **Reason**: Determines which content is available for customers to view.
- **Implementation**: The `status` of content (`published`, `draft`) is used by Content Access.

### Depends on: Admin Dashboard
- **Reason**: Provides the UI for managing content.
- **Implementation**: The Admin Dashboard contains the views and forms for content CRUD operations.

### Depends on: Auth
- **Reason**: Ensures only authorized creators can manage content.
- **Implementation**: All content management routes are protected by an ownership guard.

---

## 5. E-Commerce

### Depends on: Content Management
- **Reason**: Needs published content with a price to sell.
- **Implementation**: Reads `price` and `status` from the `content` table.

### Depends on: Content Access
- **Reason**: The `purchases` table is the source of truth for granting access.
- **Implementation**: A successful purchase record created here is what `ContentAccess` checks.

### Depends on: Auth
- **Reason**: Requires an authenticated customer to make a purchase.
- **Implementation**: Associates purchases with a `users.id`.

### Depends on: Notifications
- **Reason**: Sends purchase and refund confirmation emails.
- **Implementation**: Calls the `notificationService` after a successful webhook or refund action.

### Depends on: Admin Dashboard
- **Reason**: Provides the interface for viewing revenue and initiating refunds.
- **Implementation**: The dashboard reads purchase data and has UI actions that trigger refund logic in the E-Commerce service.

---

## 6. Media Transcoding

### Depends on: Content Management
- **Reason**: Consumes the media files uploaded by the Content Management system.
- **Implementation**: A transcoding job is enqueued after a file is uploaded and a `media_items` record is created.

### Depends on: Content Access
- **Reason**: Produces the HLS streams that the Content Access players consume.
- **Implementation**: The output of the transcoding process (e.g., `master.m3u8`) is stored in R2 and its key is saved in the `media_items` table for the player to use.

### Depends on: Admin Dashboard
- **Reason**: Displays the status of transcoding jobs.
- **Implementation**: The dashboard reads the `status` field (`transcoding`, `ready`, `failed`) from the `media_items` table.

---

## 7. Notifications

### Depends on: Auth
- **Reason**: Consumes notification service for transactional emails.
- **Implementation**: The Auth feature calls `notificationService.sendEmail()` for verification and password resets.

### Depends on: E-Commerce
- **Reason**: Consumes notification service for purchase confirmations.
- **Implementation**: The E-Commerce feature calls `notificationService.sendEmail()` for receipts.

---

## 8. Platform Settings

### Depends on: Auth
- **Reason**: Restricts access to the settings page to Platform Owners.
- **Implementation**: Uses `requireOwner()` guard.

### Depends on: Admin Dashboard
- **Reason**: The settings page is part of the admin dashboard.
- **Implementation**: The page is located at the `/admin/settings` route.

### Depends on: Notifications
- **Reason**: Provides the `platformName` and `contactEmail` used in email templates.
- **Implementation**: The notification service will fetch these settings to populate templates.

### Depends on: Content Management
- **Reason**: Uses the same R2 service and bucket strategy for logo storage.
- **Implementation**: Leverages the shared `R2Service` for logo uploads.
